<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Bugs - ORA Business Automation</title>
    
    <!-- Premium Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Source+Serif+4:wght@600&display=swap" rel="stylesheet">
    
    <!-- Global Premium Design System -->
    <link rel="stylesheet" href="/static/css/global-styles.css">
    
    <style>
        .filters-bar {
            display: flex;
            gap: calc(var(--spacing-unit) * 2);
            margin-bottom: calc(var(--spacing-unit) * 3);
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-unit));
        }
        
        .filter-group label {
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .severity-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .severity-low { background: var(--success-bg); color: var(--success-color); }
        .severity-medium { background: var(--warning-bg); color: var(--warning-color); }
        .severity-high { background: #FFE5CC; color: #E67E22; }
        .severity-critical { background: var(--error-bg); color: var(--error-color); }
        
        .status-badge-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
        }
        
        .status-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .status-badge:after {
            content: ' ‚ñæ';
            font-size: 0.6rem;
            opacity: 0.6;
        }
        
        .status-new { background: #E3F2FD; color: #1976D2; }
        .status-in_progress { background: #FFF3E0; color: #F57C00; }
        .status-resolved { background: #E8F5E9; color: #388E3C; }
        .status-closed { background: #F5F5F5; color: #757575; }
        
        /* Status dropdown menu */
        .status-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: #FFFFFF;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            min-width: 180px;
            display: none;
        }
        
        [data-theme="dark"] .status-dropdown-menu {
            background: #1e293b;
            border-color: #334155;
        }
        
        .status-dropdown-menu.show {
            display: block;
        }
        
        .status-dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .status-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .status-dropdown-item:hover {
            background: var(--bg-secondary);
        }
        
        .status-dropdown-item.active {
            background: var(--bg-secondary);
            font-weight: 600;
        }
        
        .status-dropdown-item.active:before {
            content: '‚úì';
            color: var(--success-green);
        }
        
        .incident-actions {
            display: flex;
            gap: calc(var(--spacing-unit));
        }
        
        .incident-actions button {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .incident-detail-modal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .incident-header {
            margin-bottom: calc(var(--spacing-unit) * 3);
            padding-bottom: calc(var(--spacing-unit) * 2);
            border-bottom: 1px solid var(--border-color);
        }
        
        .incident-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: calc(var(--spacing-unit) * 2);
            margin-bottom: calc(var(--spacing-unit) * 2);
        }
        
        .incident-header-top h3 {
            flex: 1;
            margin: 0;
        }
        
        .status-selector {
            min-width: 180px;
        }
        
        .status-selector select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .status-selector select:hover {
            border-color: var(--primary-color);
        }
        
        .status-selector select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(242, 153, 74, 0.1);
        }
        
        .incident-meta {
            display: flex;
            gap: calc(var(--spacing-unit) * 3);
            margin-top: calc(var(--spacing-unit) * 2);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .notes-section {
            margin-top: calc(var(--spacing-unit) * 3);
        }
        
        .note-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: calc(var(--spacing-unit) * 2);
            margin-bottom: calc(var(--spacing-unit) * 2);
        }
        
        .note-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: calc(var(--spacing-unit));
            font-size: 0.875rem;
        }
        
        .note-author {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .note-time {
            color: var(--text-secondary);
        }
        
        .note-content {
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .status-actions {
            display: flex;
            gap: calc(var(--spacing-unit));
            margin-top: calc(var(--spacing-unit) * 3);
            padding-top: calc(var(--spacing-unit) * 2);
            border-top: 1px solid var(--border-color);
        }
        
        .add-note-section {
            margin-top: calc(var(--spacing-unit) * 3);
            padding-top: calc(var(--spacing-unit) * 2);
            border-top: 1px solid var(--border-color);
        }
        
        /* Screenshot Section */
        .screenshots-section {
            margin-top: calc(var(--spacing-unit) * 3);
        }
        
        .screenshots-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: calc(var(--spacing-unit) * 2);
            margin-top: calc(var(--spacing-unit) * 2);
        }
        
        .screenshot-item {
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            background: var(--bg-secondary);
        }
        
        .screenshot-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .screenshot-item img:hover {
            transform: scale(1.05);
        }
        
        .screenshot-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--critical-red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.9;
            transition: opacity 0.2s;
        }
        
        .screenshot-delete:hover {
            opacity: 1;
        }
        
        .screenshot-info {
            padding: calc(var(--spacing-unit));
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .screenshot-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius-md);
            padding: calc(var(--spacing-unit) * 3);
            text-align: center;
            margin-top: calc(var(--spacing-unit) * 2);
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .screenshot-upload-area:hover {
            border-color: var(--accent-orange);
        }
        
        .screenshot-upload-area.dragging {
            border-color: var(--accent-orange);
            background: rgba(242, 153, 74, 0.05);
        }
        
        #screenshot-file-input {
            display: none;
        }
        
        /* Mobile Cards */
        .incidents-mobile-cards {
            display: none;
        }
        
        .incident-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: calc(var(--spacing-unit) * 2);
            margin-bottom: calc(var(--spacing-unit) * 2);
            box-shadow: var(--shadow-sm);
        }
        
        .incident-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: calc(var(--spacing-unit) * 2);
            gap: calc(var(--spacing-unit) * 2);
        }
        
        .incident-card-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            flex: 1;
        }
        
        .incident-card-badges {
            display: flex;
            gap: calc(var(--spacing-unit));
            margin-bottom: calc(var(--spacing-unit) * 1.5);
        }
        
        .incident-card-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: calc(var(--spacing-unit) * 1.5);
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: calc(var(--spacing-unit) * 2);
        }
        
        .incident-card-meta-item {
            display: flex;
            flex-direction: column;
        }
        
        .incident-card-meta-label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .incident-card-meta-value {
            color: var(--text-primary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .incidents-mobile-cards {
                display: block;
            }
            
            .table-container {
                display: none;
            }
            
            .filters-bar {
                flex-direction: column;
                gap: calc(var(--spacing-unit) * 1.5);
            }
            
            .filter-group {
                width: 100%;
            }
            
            .filter-group select {
                flex: 1;
            }
            
            .incident-meta {
                flex-direction: column;
                gap: calc(var(--spacing-unit) * 1.5);
            }
        }
    </style>
</head>
<body>
    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileMenu()"></div>

    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">O</div>
                <div class="sidebar-title">ORA Business</div>
            </div>
            
            <nav class="sidebar-nav">
                <!-- Primary Navigation -->
                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <a href="/" class="nav-item">
                        <span class="nav-item-icon">üìä</span>
                        Dashboard
                    </a>
                    <a href="/xml_import.html" class="nav-item">
                        <span class="nav-item-icon">üì•</span>
                        Orders Inbox
                    </a>
                    <a href="/inventory_transactions.html" class="nav-item">
                        <span class="nav-item-icon">üì¶</span>
                        Inventory Monitor
                    </a>
                    <a href="/lot_inventory.html" class="nav-item">
                        <span class="nav-item-icon">üè≠</span>
                        Lot Inventory
                    </a>
                    <a href="/charge_report.html" class="nav-item">
                        <span class="nav-item-icon">üí∞</span>
                        Charge Report
                    </a>
                </div>

                <!-- Admin Section -->
                <div class="nav-section admin-section">
                    <div class="admin-toggle" onclick="toggleAdmin()">
                        <span>Admin & Data</span>
                        <span class="admin-toggle-icon">‚ñ∂</span>
                    </div>
                    <div class="admin-items" id="admin-items">
                        <a href="/weekly_shipped_history.html" class="nav-item">
                            <span class="nav-item-icon">üìà</span>
                            Weekly Reports
                        </a>
                        <a href="/shipped_orders.html" class="nav-item">
                            <span class="nav-item-icon">üìã</span>
                            Shipped Orders
                        </a>
                        <a href="/order_audit.html" class="nav-item">
                            <span class="nav-item-icon">üîç</span>
                            Order Audit
                        </a>
                        <a href="/shipped_items.html" class="nav-item">
                            <span class="nav-item-icon">üìä</span>
                            Shipped Items
                        </a>
                        <a href="/bundle_skus.html" class="nav-item">
                            <span class="nav-item-icon">üì¶</span>
                            Bundle SKUs
                        </a>
                        <a href="/sku_lot.html" class="nav-item">
                            <span class="nav-item-icon">üè∑Ô∏è</span>
                            SKU Lot Management
                        </a>
                        <a href="/workflow_controls.html" class="nav-item">
                            <span class="nav-item-icon">‚öôÔ∏è</span>
                            Workflow Controls
                        </a>
                        <a href="/incidents.html" class="nav-item active">
                            <span class="nav-item-icon">üö®</span>
                            Incidents
                        </a>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="nav-section" style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: calc(var(--spacing-unit) * 2);">
                    <a href="/help.html" class="nav-item">
                        <span class="nav-item-icon">üìö</span>
                        Help & Training
                    </a>
                    <a href="/settings.html" class="nav-item">
                        <span class="nav-item-icon">‚öôÔ∏è</span>
                        Settings
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <h1 class="page-title">Production Bugs</h1>
                </div>
                <div class="top-bar-actions">
                    <button class="btn btn-primary" onclick="showReportModal()">Report Issue</button>
                    <button class="dark-mode-toggle" onclick="toggleDarkMode()">üåô</button>
                </div>
            </div>

            <div class="content-area">
                <!-- Filters -->
                <div class="filters-bar">
                    <div class="filter-group">
                        <label for="status-filter">Status:</label>
                        <select id="status-filter" onchange="applyFilters()">
                            <option value="">All</option>
                            <option value="new">New</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="severity-filter">Severity:</label>
                        <select id="severity-filter" onchange="applyFilters()">
                            <option value="">All</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="loadIncidents()" style="margin-left: auto;">
                        üîÑ Refresh
                    </button>
                </div>

                <!-- Incidents Table (Desktop) -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">All Incidents</h2>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Title</th>
                                        <th>Severity</th>
                                        <th>Status</th>
                                        <th>Reported By</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="incidents-tbody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 2rem;">
                                            Loading incidents...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Incidents Cards (Mobile) -->
                <div class="incidents-mobile-cards" id="incidents-mobile-cards">
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        Loading bugs...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Report Issue Modal -->
    <div class="modal-overlay" id="report-modal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Report New Issue</h3>
                    <button class="modal-close" onclick="hideReportModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="report-form" onsubmit="submitIncident(event)">
                        <div class="form-group">
                            <label for="incident-title">Title *</label>
                            <input type="text" id="incident-title" required maxlength="500" placeholder="Brief description of the issue">
                        </div>
                        
                        <div class="form-group">
                            <label for="incident-description">Description *</label>
                            <textarea id="incident-description" required rows="6" placeholder="Detailed description of what happened, steps to reproduce, impact, etc."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="incident-severity">Severity *</label>
                            <select id="incident-severity" required>
                                <option value="low">Low - Minor issue, workaround available</option>
                                <option value="medium" selected>Medium - Moderate impact, no workaround</option>
                                <option value="high">High - Major impact, affecting operations</option>
                                <option value="critical">Critical - System down or data loss</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="reported-by">Your Name</label>
                            <input type="text" id="reported-by" value="Dashboard User" placeholder="Your name">
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn btn-secondary" onclick="attachFromClipboard('report')" style="width: 100%; margin-bottom: 12px; justify-content: center;">
                                üìã Attach from Clipboard
                            </button>
                            <label>Attach Screenshots (Optional)</label>
                            <div class="screenshot-upload-area" onclick="document.getElementById('report-screenshot-input').click()" 
                                 ondragover="handleDragOver(event)" ondrop="handleDropReport(event)" ondragleave="handleDragLeave(event)">
                                <input type="file" id="report-screenshot-input" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" multiple style="display: none;">
                                <p style="color: var(--text-secondary); margin: 0;">
                                    üìé Click to attach or drag & drop screenshots
                                </p>
                                <p style="color: var(--text-tertiary); font-size: 12px; margin-top: 8px;">
                                    PNG, JPG, GIF, WEBP (max 16MB each)
                                </p>
                            </div>
                            <div id="report-screenshots-preview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 12px;"></div>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="hideReportModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Submit Issue</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Incident Detail Modal -->
    <div class="modal-overlay" id="detail-modal" style="display: none;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Bug Details</h3>
                    <button class="modal-close" onclick="hideDetailModal()">&times;</button>
                </div>
                <div class="modal-body incident-detail-modal">
                    <div id="incident-detail-content">
                        <!-- Content loaded dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Incident Modal -->
    <div class="modal-overlay" id="edit-modal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Edit Bug</h3>
                    <button class="modal-close" onclick="hideEditModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="edit-form" onsubmit="saveIncidentEdit(event)">
                        <input type="hidden" id="edit-incident-id">
                        <div class="form-group">
                            <label for="edit-incident-title">Title *</label>
                            <input type="text" id="edit-incident-title" required maxlength="500">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-incident-description">Description *</label>
                            <textarea id="edit-incident-description" required rows="6"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-incident-severity">Severity *</label>
                            <select id="edit-incident-severity" required>
                                <option value="low">Low - Minor issue, workaround available</option>
                                <option value="medium">Medium - Moderate impact, no workaround</option>
                                <option value="high">High - Major impact, affecting operations</option>
                                <option value="critical">Critical - System down or data loss</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-incident-cause">Root Cause (Optional)</label>
                            <textarea id="edit-incident-cause" rows="3" placeholder="What caused this bug?"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-incident-resolution">Resolution (Optional)</label>
                            <textarea id="edit-incident-resolution" rows="3" placeholder="How was this bug resolved?"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn btn-secondary" onclick="attachFromClipboard('edit')" style="width: 100%; margin-bottom: 12px; justify-content: center;">
                                üìã Attach from Clipboard
                            </button>
                            <label>Attach Screenshots (Optional)</label>
                            <div class="screenshot-upload-area" onclick="document.getElementById('edit-screenshot-input').click()" 
                                 ondragover="handleDragOver(event)" ondrop="handleDropEdit(event)" ondragleave="handleDragLeave(event)">
                                <input type="file" id="edit-screenshot-input" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" multiple style="display: none;">
                                <p style="color: var(--text-secondary); margin: 0;">
                                    üìé Click to attach or drag & drop screenshots
                                </p>
                                <p style="color: var(--text-tertiary); font-size: 12px; margin-top: 8px;">
                                    PNG, JPG, GIF, WEBP (max 16MB each)
                                </p>
                            </div>
                            <div id="edit-screenshots-preview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 12px;"></div>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="hideEditModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allIncidents = [];
        let currentIncident = null;

        // Load incidents on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadIncidents();
            initDarkMode();
            
            // Auto-open report modal if URL hash is #report
            if (window.location.hash === '#report') {
                showReportModal();
                // Clear the hash without affecting history
                history.replaceState(null, null, ' ');
            }
        });

        async function loadIncidents() {
            try {
                const statusFilter = document.getElementById('status-filter').value;
                const severityFilter = document.getElementById('severity-filter').value;
                
                let url = '/api/incidents';
                const params = new URLSearchParams();
                if (statusFilter) params.append('status', statusFilter);
                if (severityFilter) params.append('severity', severityFilter);
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    allIncidents = data.incidents;
                    renderIncidents();
                } else {
                    console.error('Failed to load bugs:', data.error);
                    showError('Failed to load bugs');
                }
            } catch (error) {
                console.error('Error loading incidents:', error);
                showError('Error loading incidents');
            }
        }

        function renderIncidents() {
            const tbody = document.getElementById('incidents-tbody');
            const mobileCards = document.getElementById('incidents-mobile-cards');
            
            if (allIncidents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No bugs found</td></tr>';
                mobileCards.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No bugs found</div>';
                return;
            }
            
            // Render desktop table
            tbody.innerHTML = allIncidents.map(incident => `
                <tr>
                    <td>${incident.id}</td>
                    <td><strong>${escapeHtml(incident.title)}</strong></td>
                    <td><span class="severity-badge severity-${incident.severity}">${incident.severity}</span></td>
                    <td><div class="status-badge-wrapper"><span class="status-badge status-${incident.status}" onclick="showStatusDropdown(event, ${incident.id}, '${incident.status}')">${formatStatus(incident.status)}</span></div></td>
                    <td>${escapeHtml(incident.reported_by)}</td>
                    <td>${formatDate(incident.created_at)}</td>
                    <td>
                        <div class="incident-actions">
                            <button class="btn btn-sm btn-secondary" onclick="viewIncident(${incident.id})">View</button>
                            <button class="btn btn-sm btn-primary" onclick="showEditModal(${incident.id})">Edit</button>
                            <button class="btn btn-sm" onclick="deleteIncident(${incident.id})" style="background: var(--critical-red); color: white; border-color: var(--critical-red);">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Render mobile cards
            mobileCards.innerHTML = allIncidents.map(incident => `
                <div class="incident-card">
                    <div class="incident-card-header">
                        <div class="incident-card-title">${escapeHtml(incident.title)}</div>
                    </div>
                    <div class="incident-card-badges">
                        <span class="severity-badge severity-${incident.severity}">${incident.severity}</span>
                        <div class="status-badge-wrapper"><span class="status-badge status-${incident.status}" onclick="showStatusDropdown(event, ${incident.id}, '${incident.status}')">${formatStatus(incident.status)}</span></div>
                    </div>
                    <div class="incident-card-meta">
                        <div class="incident-card-meta-item">
                            <div class="incident-card-meta-label">ID</div>
                            <div class="incident-card-meta-value">#${incident.id}</div>
                        </div>
                        <div class="incident-card-meta-item">
                            <div class="incident-card-meta-label">Reported By</div>
                            <div class="incident-card-meta-value">${escapeHtml(incident.reported_by)}</div>
                        </div>
                        <div class="incident-card-meta-item">
                            <div class="incident-card-meta-label">Created</div>
                            <div class="incident-card-meta-value">${formatDate(incident.created_at)}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: calc(var(--spacing-unit)); margin-top: calc(var(--spacing-unit));">
                        <button class="btn btn-secondary" onclick="viewIncident(${incident.id})" style="flex: 1;">View</button>
                        <button class="btn btn-primary" onclick="showEditModal(${incident.id})" style="flex: 1;">Edit</button>
                        <button class="btn" onclick="deleteIncident(${incident.id})" style="flex: 1; background: var(--critical-red); color: white; border-color: var(--critical-red);">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function applyFilters() {
            loadIncidents();
        }

        async function submitIncident(event) {
            event.preventDefault();
            
            const title = document.getElementById('incident-title').value;
            const description = document.getElementById('incident-description').value;
            const severity = document.getElementById('incident-severity').value;
            const reportedBy = document.getElementById('reported-by').value || 'Dashboard User';
            
            try {
                const response = await fetch('/api/incidents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description, severity, reported_by: reportedBy })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const incidentId = data.incident_id;
                    
                    // Attach screenshots if any
                    const fileInput = document.getElementById('report-screenshot-input');
                    if (fileInput.files.length > 0) {
                        await attachScreenshotsToIncident(incidentId, fileInput.files, reportedBy);
                    }
                    
                    hideReportModal();
                    document.getElementById('report-form').reset();
                    document.getElementById('report-screenshots-preview').innerHTML = '';
                    loadIncidents();
                    showSuccess('Issue reported successfully' + (fileInput.files.length > 0 ? ` with ${fileInput.files.length} screenshot(s)` : ''));
                } else {
                    showError(data.error || 'Failed to submit issue');
                }
            } catch (error) {
                console.error('Error submitting incident:', error);
                showError('Error submitting issue');
            }
        }

        function viewIncident(incidentId) {
            currentIncident = allIncidents.find(i => i.id === incidentId);
            if (!currentIncident) return;
            
            const content = document.getElementById('incident-detail-content');
            content.innerHTML = `
                <div class="incident-header">
                    <div class="incident-header-top">
                        <h3>${escapeHtml(currentIncident.title)}</h3>
                        <div class="status-selector">
                            <select id="status-dropdown" onchange="handleStatusChange(this.value)">
                                <option value="new" ${currentIncident.status === 'new' ? 'selected' : ''}>üÜï New</option>
                                <option value="in_progress" ${currentIncident.status === 'in_progress' ? 'selected' : ''}>‚è≥ In Progress</option>
                                <option value="resolved" ${currentIncident.status === 'resolved' ? 'selected' : ''}>‚úÖ Resolved</option>
                                <option value="closed" ${currentIncident.status === 'closed' ? 'selected' : ''}>üîí Closed</option>
                            </select>
                        </div>
                    </div>
                    <div class="incident-meta">
                        <div><strong>ID:</strong> ${currentIncident.id}</div>
                        <div><strong>Severity:</strong> <span class="severity-badge severity-${currentIncident.severity}">${currentIncident.severity}</span></div>
                        <div><strong>Reported by:</strong> ${escapeHtml(currentIncident.reported_by)}</div>
                        <div><strong>Created:</strong> ${formatDate(currentIncident.created_at)}</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><strong>Description</strong></label>
                    <div style="white-space: pre-wrap; line-height: 1.6;">${escapeHtml(currentIncident.description)}</div>
                </div>
                
                ${currentIncident.cause || currentIncident.resolution ? `
                    <div class="form-group" style="margin-top: calc(var(--spacing-unit) * 3); padding-top: calc(var(--spacing-unit) * 2); border-top: 1px solid var(--border-color);">
                        ${currentIncident.cause ? `
                            <div style="margin-bottom: calc(var(--spacing-unit) * 2);">
                                <label><strong>Root Cause</strong></label>
                                <div style="white-space: pre-wrap; line-height: 1.6; color: var(--text-primary);">${escapeHtml(currentIncident.cause)}</div>
                            </div>
                        ` : ''}
                        ${currentIncident.resolution ? `
                            <div>
                                <label><strong>Resolution</strong></label>
                                <div style="white-space: pre-wrap; line-height: 1.6; color: var(--text-primary);">${escapeHtml(currentIncident.resolution)}</div>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                
                <div class="notes-section">
                    <h4>Notes & Updates</h4>
                    <div id="notes-list">
                        ${currentIncident.notes.length > 0 
                            ? currentIncident.notes.map(note => `
                                <div class="note-item">
                                    <div class="note-header">
                                        <span class="note-author">${escapeHtml(note.created_by)}</span>
                                        <span class="note-time">${formatDate(note.created_at)}</span>
                                    </div>
                                    <div class="note-content">${escapeHtml(note.note)}</div>
                                </div>
                            `).join('')
                            : '<p style="color: var(--text-secondary);">No notes yet</p>'
                        }
                    </div>
                </div>
                
                <div class="screenshots-section">
                    <h4>Screenshots</h4>
                    <div id="screenshots-gallery" class="screenshots-gallery"></div>
                    <div class="screenshot-upload-area" onclick="document.getElementById('screenshot-file-input').click()" 
                         ondragover="handleDragOver(event)" ondrop="handleDrop(event)" ondragleave="handleDragLeave(event)">
                        <input type="file" id="screenshot-file-input" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" 
                               onchange="uploadScreenshot(event)" multiple>
                        <p style="color: var(--text-secondary); margin: 0;">
                            üìé Click to attach or drag & drop screenshots
                        </p>
                        <p style="color: var(--text-tertiary); font-size: 12px; margin-top: 8px;">
                            PNG, JPG, GIF, WEBP (max 16MB each)
                        </p>
                    </div>
                </div>
                
                <div class="add-note-section">
                    <h4>Add Note</h4>
                    <form onsubmit="addNote(event)">
                        <div class="form-group">
                            <textarea id="new-note" rows="3" placeholder="Add a note or update..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-secondary">Add Note</button>
                    </form>
                </div>
            `;
            
            document.getElementById('detail-modal').style.display = 'flex';
            
            // Load screenshots for this incident
            loadScreenshots();
        }

        async function handleStatusChange(newStatus) {
            if (!currentIncident || currentIncident.status === newStatus) return;
            
            // WORKFLOW RULE: Definition of Done - Can't mark as "resolved" without proof
            if (newStatus === 'resolved') {
                if (!currentIncident.resolution || !currentIncident.resolution.trim()) {
                    showError('‚ùå Definition of Done: Can\'t mark as "Resolved" without proof.\n\nPlease edit this incident and add a Resolution documenting:\n1. Fix Applied\n2. Verified Working\n3. Evidence Captured');
                    document.getElementById('status-dropdown').value = currentIncident.status;
                    return;
                }
            }
            
            // Confirm status change
            const statusLabels = {
                'new': 'New',
                'in_progress': 'In Progress',
                'resolved': 'Resolved',
                'closed': 'Closed'
            };
            
            if (!confirm(`Change status to "${statusLabels[newStatus]}"?`)) {
                // Reset dropdown to current status
                document.getElementById('status-dropdown').value = currentIncident.status;
                return;
            }
            
            try {
                const response = await fetch(`/api/incidents/${currentIncident.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentIncident.status = newStatus;
                    loadIncidents();
                    showSuccess(`Status updated to ${statusLabels[newStatus]}`);
                } else {
                    showError(data.error || 'Failed to update status');
                    // Reset dropdown on error
                    document.getElementById('status-dropdown').value = currentIncident.status;
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showError('Error updating status');
                // Reset dropdown on error
                document.getElementById('status-dropdown').value = currentIncident.status;
            }
        }

        async function updateStatus(newStatus) {
            if (!currentIncident) return;
            
            try {
                const response = await fetch(`/api/incidents/${currentIncident.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    hideDetailModal();
                    loadIncidents();
                    showSuccess('Status updated successfully');
                } else {
                    showError(data.error || 'Failed to update status');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showError('Error updating status');
            }
        }

        async function addNote(event) {
            event.preventDefault();
            if (!currentIncident) return;
            
            const noteText = document.getElementById('new-note').value;
            
            try {
                const response = await fetch(`/api/incidents/${currentIncident.id}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        note: noteText, 
                        note_type: 'user',
                        created_by: 'Dashboard User'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('new-note').value = '';
                    await loadIncidents();
                    viewIncident(currentIncident.id);
                    showSuccess('Note added successfully');
                } else {
                    showError(data.error || 'Failed to add note');
                }
            } catch (error) {
                console.error('Error adding note:', error);
                showError('Error adding note');
            }
        }

        async function deleteIncident(incidentId) {
            const incident = allIncidents.find(i => i.id === incidentId);
            if (!incident) return;
            
            if (!confirm(`‚ö†Ô∏è Delete Incident #${incidentId}?\n\n"${incident.title}"\n\nThis will permanently delete the incident and all associated screenshots and notes. This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/incidents/${incidentId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Close detail modal if open
                    if (currentIncident && currentIncident.id === incidentId) {
                        hideDetailModal();
                    }
                    
                    await loadIncidents();
                    showSuccess('Incident deleted successfully');
                } else {
                    showError(data.error || 'Failed to delete bug');
                }
            } catch (error) {
                console.error('Error deleting incident:', error);
                showError('Error deleting incident');
            }
        }

        // Modal helpers
        function showReportModal() {
            document.getElementById('report-modal').style.display = 'flex';
        }

        function hideReportModal() {
            document.getElementById('report-modal').style.display = 'none';
            document.getElementById('report-form').reset();
            document.getElementById('report-screenshots-preview').innerHTML = '';
        }

        function hideDetailModal() {
            document.getElementById('detail-modal').style.display = 'none';
            currentIncident = null;
        }

        // Track original values for edit modal
        let originalEditValues = {};

        function showEditModal(incidentId) {
            const incident = allIncidents.find(inc => inc.id === incidentId);
            if (!incident) return;
            
            document.getElementById('edit-incident-id').value = incident.id;
            document.getElementById('edit-incident-title').value = incident.title;
            document.getElementById('edit-incident-description').value = incident.description;
            document.getElementById('edit-incident-severity').value = incident.severity;
            document.getElementById('edit-incident-cause').value = incident.cause || '';
            document.getElementById('edit-incident-resolution').value = incident.resolution || '';
            
            // Store original values for change detection
            originalEditValues = {
                title: incident.title,
                description: incident.description,
                severity: incident.severity,
                cause: incident.cause || '',
                resolution: incident.resolution || ''
            };
            
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function hasEditChanges() {
            const currentTitle = document.getElementById('edit-incident-title').value;
            const currentDescription = document.getElementById('edit-incident-description').value;
            const currentSeverity = document.getElementById('edit-incident-severity').value;
            const currentCause = document.getElementById('edit-incident-cause').value;
            const currentResolution = document.getElementById('edit-incident-resolution').value;
            const fileInput = document.getElementById('edit-screenshot-input');
            
            return currentTitle !== originalEditValues.title ||
                   currentDescription !== originalEditValues.description ||
                   currentSeverity !== originalEditValues.severity ||
                   currentCause !== originalEditValues.cause ||
                   currentResolution !== originalEditValues.resolution ||
                   fileInput.files.length > 0;
        }

        function hideEditModal(force = false) {
            if (!force && hasEditChanges()) {
                if (!confirm('You have unsaved changes. Are you sure you want to close without saving?')) {
                    return;
                }
            }
            
            document.getElementById('edit-modal').style.display = 'none';
            document.getElementById('edit-form').reset();
            document.getElementById('edit-screenshots-preview').innerHTML = '';
            originalEditValues = {};
        }

        async function saveIncidentEdit(event) {
            event.preventDefault();
            
            const incidentId = document.getElementById('edit-incident-id').value;
            const title = document.getElementById('edit-incident-title').value;
            const description = document.getElementById('edit-incident-description').value;
            const severity = document.getElementById('edit-incident-severity').value;
            const cause = document.getElementById('edit-incident-cause').value;
            const resolution = document.getElementById('edit-incident-resolution').value;
            
            try {
                const response = await fetch(`/api/incidents/${incidentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description, severity, cause, resolution })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Attach screenshots if any
                    const fileInput = document.getElementById('edit-screenshot-input');
                    if (fileInput.files.length > 0) {
                        await attachScreenshotsToIncident(incidentId, fileInput.files, 'Dashboard User');
                    }
                    
                    hideEditModal(true); // Force close without confirmation after successful save
                    await loadIncidents();
                    showSuccess('Incident updated successfully' + (fileInput.files.length > 0 ? ` with ${fileInput.files.length} screenshot(s)` : ''));
                } else {
                    showError(data.error || 'Failed to update bug');
                }
            } catch (error) {
                console.error('Error updating incident:', error);
                showError('Error updating incident');
            }
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            // Ensure the timestamp is treated as UTC by appending 'Z' if not present
            let isoString = dateString;
            if (!isoString.endsWith('Z') && !isoString.includes('+')) {
                isoString = isoString + 'Z';
            }
            
            const date = new Date(isoString);
            
            // Return in user's local timezone
            return date.toLocaleString(undefined, {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }

        function formatStatus(status) {
            return status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Status dropdown functionality
        let activeDropdown = null;
        
        function showStatusDropdown(event, incidentId, currentStatus) {
            event.stopPropagation();
            
            // Close existing dropdown
            if (activeDropdown) {
                activeDropdown.remove();
            }
            
            // Create dropdown menu
            const dropdown = document.createElement('div');
            dropdown.className = 'status-dropdown-menu show';
            dropdown.innerHTML = `
                <div class="status-dropdown-item ${currentStatus === 'new' ? 'active' : ''}" onclick="changeIncidentStatus(event, ${incidentId}, 'new')">
                    üÜï New
                </div>
                <div class="status-dropdown-item ${currentStatus === 'in_progress' ? 'active' : ''}" onclick="changeIncidentStatus(event, ${incidentId}, 'in_progress')">
                    ‚è≥ In Progress
                </div>
                <div class="status-dropdown-item ${currentStatus === 'resolved' ? 'active' : ''}" onclick="changeIncidentStatus(event, ${incidentId}, 'resolved')">
                    ‚úÖ Resolved
                </div>
                <div class="status-dropdown-item ${currentStatus === 'closed' ? 'active' : ''}" onclick="changeIncidentStatus(event, ${incidentId}, 'closed')">
                    üîí Closed
                </div>
            `;
            
            // Append dropdown to wrapper (parent of badge)
            const badge = event.target;
            const wrapper = badge.parentElement;
            wrapper.appendChild(dropdown);
            
            activeDropdown = dropdown;
        }
        
        async function changeIncidentStatus(event, incidentId, newStatus) {
            event.stopPropagation();
            
            // Close dropdown
            if (activeDropdown) {
                activeDropdown.remove();
                activeDropdown = null;
            }
            
            const statusLabels = {
                'new': 'New',
                'in_progress': 'In Progress',
                'resolved': 'Resolved',
                'closed': 'Closed'
            };
            
            if (!confirm(`Change status to "${statusLabels[newStatus]}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/incidents/${incidentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await loadIncidents();
                    showSuccess(`Status updated to ${statusLabels[newStatus]}`);
                } else {
                    showError(data.error || 'Failed to update status');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                showError('Error updating status');
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            if (activeDropdown && !event.target.closest('.status-badge')) {
                activeDropdown.remove();
                activeDropdown = null;
            }
        });

        // Screenshot Management
        async function loadScreenshots() {
            if (!currentIncident) return;
            
            try {
                const response = await fetch(`/api/incidents/${currentIncident.id}/screenshots`);
                const data = await response.json();
                
                if (data.success) {
                    displayScreenshots(data.screenshots);
                }
            } catch (error) {
                console.error('Error loading screenshots:', error);
            }
        }

        function displayScreenshots(screenshots) {
            const gallery = document.getElementById('screenshots-gallery');
            
            if (screenshots.length === 0) {
                gallery.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No screenshots yet</p>';
                return;
            }
            
            gallery.innerHTML = screenshots.map(screenshot => `
                <div class="screenshot-item">
                    <img src="${screenshot.url}" alt="${screenshot.original_filename}" 
                         onclick="viewScreenshot('${screenshot.url}', '${screenshot.original_filename}')">
                    <button class="screenshot-delete" onclick="deleteScreenshot(${screenshot.id})" title="Delete screenshot">√ó</button>
                    <div class="screenshot-info">
                        ${screenshot.original_filename.length > 20 
                            ? screenshot.original_filename.substring(0, 17) + '...' 
                            : screenshot.original_filename}
                        <br><small>${formatFileSize(screenshot.file_size)}</small>
                    </div>
                </div>
            `).join('');
        }

        async function uploadScreenshot(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('uploaded_by', 'Dashboard User');
                
                try {
                    showMessage(`Attaching ${file.name}...`, 'info');
                    
                    const response = await fetch(`/api/incidents/${currentIncident.id}/screenshots`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showMessage(`${file.name} attached successfully`, 'success');
                        await loadScreenshots();
                    } else {
                        showError(data.error || `Failed to attach ${file.name}`);
                    }
                } catch (error) {
                    console.error('Attach error:', error);
                    showError(`Error attaching ${file.name}`);
                }
            }
            
            // Reset file input
            event.target.value = '';
        }

        // Helper function to attach multiple screenshots to an incident
        async function attachScreenshotsToIncident(incidentId, files, uploadedBy) {
            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('uploaded_by', uploadedBy);
                
                try {
                    const response = await fetch(`/api/incidents/${incidentId}/screenshots`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    if (!data.success) {
                        console.error(`Failed to attach ${file.name}:`, data.error);
                    }
                } catch (error) {
                    console.error(`Error attaching ${file.name}:`, error);
                }
            }
        }

        async function deleteScreenshot(screenshotId) {
            if (!confirm('Are you sure you want to delete this screenshot?')) return;
            
            try {
                const response = await fetch(`/api/incidents/screenshots/${screenshotId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Screenshot deleted successfully', 'success');
                    await loadScreenshots();
                } else {
                    showError(data.error || 'Failed to delete screenshot');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showError('Error deleting screenshot');
            }
        }

        function viewScreenshot(url, filename) {
            window.open(url, '_blank');
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.add('dragging');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragging');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragging');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                // Trigger upload with dropped files
                const fileInput = document.getElementById('screenshot-file-input');
                fileInput.files = files;
                uploadScreenshot({ target: fileInput });
            }
        }

        // Handle drag & drop for report modal
        function handleDropReport(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragging');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById('report-screenshot-input');
                fileInput.files = files;
                previewReportScreenshots(files);
            }
        }

        // Handle drag & drop for edit modal
        function handleDropEdit(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragging');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById('edit-screenshot-input');
                fileInput.files = files;
                previewEditScreenshots(files);
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Preview screenshots in report modal with smooth resize
        function previewReportScreenshots(files) {
            const preview = document.getElementById('report-screenshots-preview');
            const modalDialog = document.getElementById('report-modal').querySelector('.modal-dialog');
            
            preview.innerHTML = '';
            
            // Track animation count
            if (!modalDialog._animCount) modalDialog._animCount = 0;
            const totalFiles = files.length;
            let processedFiles = 0;
            
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Capture height before adding
                    const beforeHeight = modalDialog.offsetHeight;
                    
                    const div = document.createElement('div');
                    div.style.cssText = 'position: relative; border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden;';
                    div.innerHTML = `
                        <img src="${e.target.result}" style="width: 100%; height: 80px; object-fit: cover;">
                        <button type="button" onclick="removeReportScreenshot(${index})" style="position: absolute; top: 2px; right: 2px; background: var(--critical-red); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 14px; line-height: 1;">√ó</button>
                    `;
                    preview.appendChild(div);
                    
                    processedFiles++;
                    
                    // Smooth resize animation for each thumbnail
                    requestAnimationFrame(() => {
                        const afterHeight = modalDialog.offsetHeight;
                        if (afterHeight !== beforeHeight) {
                            modalDialog._animCount++;
                            modalDialog.style.height = beforeHeight + 'px';
                            requestAnimationFrame(() => {
                                modalDialog.style.transition = 'height 0.25s cubic-bezier(0.4, 0, 0.2, 1)';
                                modalDialog.style.height = afterHeight + 'px';
                                setTimeout(() => {
                                    modalDialog._animCount--;
                                    // Only cleanup when all animations complete
                                    if (modalDialog._animCount === 0 && processedFiles === totalFiles) {
                                        modalDialog.style.height = '';
                                        modalDialog.style.transition = '';
                                    }
                                }, 250);
                            });
                        }
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        // Preview screenshots in edit modal with smooth resize
        function previewEditScreenshots(files) {
            const preview = document.getElementById('edit-screenshots-preview');
            const modalDialog = document.getElementById('edit-modal').querySelector('.modal-dialog');
            
            preview.innerHTML = '';
            
            // Track animation count
            if (!modalDialog._animCount) modalDialog._animCount = 0;
            const totalFiles = files.length;
            let processedFiles = 0;
            
            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    // Capture height before adding
                    const beforeHeight = modalDialog.offsetHeight;
                    
                    const div = document.createElement('div');
                    div.style.cssText = 'position: relative; border: 1px solid var(--border-color); border-radius: 4px; overflow: hidden;';
                    div.innerHTML = `
                        <img src="${e.target.result}" style="width: 100%; height: 80px; object-fit: cover;">
                        <button type="button" onclick="removeEditScreenshot(${index})" style="position: absolute; top: 2px; right: 2px; background: var(--critical-red); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 14px; line-height: 1;">√ó</button>
                    `;
                    preview.appendChild(div);
                    
                    processedFiles++;
                    
                    // Smooth resize animation for each thumbnail
                    requestAnimationFrame(() => {
                        const afterHeight = modalDialog.offsetHeight;
                        if (afterHeight !== beforeHeight) {
                            modalDialog._animCount++;
                            modalDialog.style.height = beforeHeight + 'px';
                            requestAnimationFrame(() => {
                                modalDialog.style.transition = 'height 0.25s cubic-bezier(0.4, 0, 0.2, 1)';
                                modalDialog.style.height = afterHeight + 'px';
                                setTimeout(() => {
                                    modalDialog._animCount--;
                                    // Only cleanup when all animations complete
                                    if (modalDialog._animCount === 0 && processedFiles === totalFiles) {
                                        modalDialog.style.height = '';
                                        modalDialog.style.transition = '';
                                    }
                                }, 250);
                            });
                        }
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        function removeReportScreenshot(index) {
            const input = document.getElementById('report-screenshot-input');
            const dt = new DataTransfer();
            Array.from(input.files).forEach((file, i) => {
                if (i !== index) dt.items.add(file);
            });
            input.files = dt.files;
            previewReportScreenshots(input.files);
        }

        function removeEditScreenshot(index) {
            const input = document.getElementById('edit-screenshot-input');
            const dt = new DataTransfer();
            Array.from(input.files).forEach((file, i) => {
                if (i !== index) dt.items.add(file);
            });
            input.files = dt.files;
            previewEditScreenshots(input.files);
        }

        // Attach from clipboard button handler
        async function attachFromClipboard(modalType) {
            try {
                const clipboardItems = await navigator.clipboard.read();
                let imageFound = false;
                
                for (const clipboardItem of clipboardItems) {
                    for (const type of clipboardItem.types) {
                        if (type.startsWith('image/')) {
                            const blob = await clipboardItem.getType(type);
                            const file = new File([blob], `clipboard-${Date.now()}.png`, { type: blob.type });
                            
                            let targetInput, previewFunction;
                            
                            if (modalType === 'report') {
                                targetInput = document.getElementById('report-screenshot-input');
                                previewFunction = previewReportScreenshots;
                            } else if (modalType === 'edit') {
                                targetInput = document.getElementById('edit-screenshot-input');
                                previewFunction = previewEditScreenshots;
                            }
                            
                            if (targetInput && previewFunction) {
                                const dt = new DataTransfer();
                                // Add existing files
                                Array.from(targetInput.files).forEach(f => dt.items.add(f));
                                // Add clipboard file
                                dt.items.add(file);
                                
                                targetInput.files = dt.files;
                                previewFunction(targetInput.files);
                                imageFound = true;
                            }
                        }
                    }
                }
                
                if (imageFound) {
                    showMessage('Screenshot attached from clipboard', 'success');
                } else {
                    showMessage('No image found in clipboard', 'info');
                }
            } catch (error) {
                console.error('Clipboard error:', error);
                if (error.name === 'NotAllowedError') {
                    showError('Permission denied. Please allow clipboard access or use Ctrl+V to paste.');
                } else {
                    showError('Could not read from clipboard. Try using Ctrl+V to paste instead.');
                }
            }
        }

        // Setup file input change handlers and clipboard paste
        document.addEventListener('DOMContentLoaded', () => {
            const reportInput = document.getElementById('report-screenshot-input');
            if (reportInput) {
                reportInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        previewReportScreenshots(e.target.files);
                    }
                });
            }

            const editInput = document.getElementById('edit-screenshot-input');
            if (editInput) {
                editInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        previewEditScreenshots(e.target.files);
                    }
                });
            }

            // Global ESC key handler for modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const reportModal = document.getElementById('report-modal');
                    const editModal = document.getElementById('edit-modal');
                    const detailModal = document.getElementById('detail-modal');

                    // Check which modal is open and close it
                    if (reportModal && reportModal.style.display === 'flex') {
                        hideReportModal();
                    } else if (editModal && editModal.style.display === 'flex') {
                        hideEditModal(); // Will show confirmation if there are changes
                    } else if (detailModal && detailModal.style.display === 'flex') {
                        hideDetailModal();
                    }
                }
            });

            // Global paste event handler for clipboard screenshots
            document.addEventListener('paste', (e) => {
                const items = e.clipboardData?.items;
                if (!items) return;

                // Find image items in clipboard
                const imageItems = Array.from(items).filter(item => item.type.startsWith('image/'));
                if (imageItems.length === 0) return;

                // Determine which modal is open
                const reportModal = document.getElementById('report-modal');
                const editModal = document.getElementById('edit-modal');
                const detailModal = document.getElementById('detail-modal');

                let targetInput = null;
                let previewFunction = null;

                if (reportModal && reportModal.style.display === 'flex') {
                    targetInput = document.getElementById('report-screenshot-input');
                    previewFunction = previewReportScreenshots;
                } else if (editModal && editModal.style.display === 'flex') {
                    targetInput = document.getElementById('edit-screenshot-input');
                    previewFunction = previewEditScreenshots;
                } else if (detailModal && detailModal.style.display === 'flex') {
                    // For detail modal, upload immediately
                    imageItems.forEach(item => {
                        const file = item.getAsFile();
                        if (file && currentIncident) {
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('uploaded_by', 'Dashboard User');
                            
                            showMessage(`Attaching clipboard image...`, 'info');
                            
                            fetch(`/api/incidents/${currentIncident.id}/screenshots`, {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    showMessage('Clipboard image attached successfully', 'success');
                                    loadScreenshots();
                                } else {
                                    showError(data.error || 'Failed to attach clipboard image');
                                }
                            })
                            .catch(error => {
                                console.error('Attach error:', error);
                                showError('Error attaching clipboard image');
                            });
                        }
                    });
                    return;
                }

                // Handle paste for report/edit modals
                if (targetInput && previewFunction) {
                    e.preventDefault();
                    
                    const dt = new DataTransfer();
                    // Add existing files
                    Array.from(targetInput.files).forEach(file => dt.items.add(file));
                    // Add pasted images
                    imageItems.forEach(item => {
                        const file = item.getAsFile();
                        if (file) dt.items.add(file);
                    });
                    
                    targetInput.files = dt.files;
                    previewFunction(targetInput.files);
                    
                    showMessage(`Pasted ${imageItems.length} image(s) from clipboard`, 'success');
                }
            });
        });

        function showMessage(message, type) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? 'var(--success-teal)' : type === 'info' ? 'var(--accent-orange)' : 'var(--critical-red)'};
                color: white;
                border-radius: var(--border-radius-md);
                box-shadow: var(--shadow-lg);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showSuccess(message) {
            alert(message);
        }

        function showError(message) {
            alert('Error: ' + message);
        }

        // Mobile menu and dark mode (from global-styles.css)
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        function toggleAdmin() {
            const adminItems = document.getElementById('admin-items');
            const adminToggle = document.querySelector('.admin-toggle-icon');
            adminItems.classList.toggle('expanded');
            adminToggle.textContent = adminItems.classList.contains('expanded') ? '‚ñº' : '‚ñ∂';
        }

        function initDarkMode() {
            const darkModeEnabled = localStorage.getItem('darkMode') === 'true';
            if (darkModeEnabled) {
                document.body.classList.add('dark-mode');
                document.querySelector('.dark-mode-toggle').textContent = '‚òÄÔ∏è';
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.querySelector('.dark-mode-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }
    </script>
</body>
</html>
