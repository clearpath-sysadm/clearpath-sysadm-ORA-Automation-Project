<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Oracare Fulfillment - Dashboard</title>
    
    <!-- Premium Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Source+Serif+4:wght@600&display=swap" rel="stylesheet">
    
    <!-- Global Premium Design System -->
    <link rel="stylesheet" href="/static/css/global-styles.css">
    
    <!-- Dashboard-Specific Styles (alerts, modals, mobile utilities) -->
    <link rel="stylesheet" href="/static/css/dashboard-specific.css">
    
    <!-- Contextual Help Tooltips -->
    <link rel="stylesheet" href="/static/tooltips.css">
    
    <!-- Health Check Modal -->
    <script src="/static/health-check-modal.js" defer></script>
    
    <style>
        /* User Widget Styles */
        .user-widget {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin: calc(var(--spacing-unit) * 2) calc(var(--spacing-unit) * 2) 0;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            background: var(--accent-orange);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-avatar-initials {
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-role-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-role-badge.admin {
            background: rgba(242, 153, 74, 0.15);
            color: var(--accent-orange);
        }

        .user-role-badge.viewer {
            background: rgba(147, 197, 253, 0.15);
            color: #60A5FA;
        }

        .user-logout-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .user-logout-btn:hover {
            background: var(--bg-hover);
            color: var(--accent-orange);
            border-color: var(--accent-orange);
        }

        .user-logout-btn:active {
            transform: scale(0.95);
        }
    </style>
    
</head>
<body>
    <!-- Shipping Violations Alert Banner -->
    <div class="violations-alert" id="violations-alert">
        <div class="violations-content">
            <span class="violations-icon">‚ö†Ô∏è</span>
            <div class="violations-text">
                <div class="violations-title">Shipping Configuration Alerts</div>
                <div class="violations-details" id="violations-summary">Loading...</div>
            </div>
        </div>
        <div class="violations-actions">
            <button class="btn-view-violations" onclick="openViolationsModal()">View Details</button>
            <button class="btn-dismiss-alert" onclick="dismissAlert()" title="Dismiss">√ó</button>
        </div>
    </div>

    <!-- Violations Modal -->
    <div class="violations-modal" id="violations-modal" onclick="closeModalOnBackdrop(event)">
        <div class="violations-modal-content">
            <div class="violations-modal-header">
                <h2 class="violations-modal-title">Shipping Configuration Alerts</h2>
                <button class="btn-close-modal" onclick="closeViolationsModal()">√ó</button>
            </div>
            <div id="violations-list">
                <p style="text-align: center; color: var(--text-tertiary);">Loading violations...</p>
            </div>
        </div>
    </div>

    <!-- Production Health Modal -->
    <div class="violations-modal" id="health-modal" onclick="closeModalOnBackdrop(event)">
        <div class="violations-modal-content">
            <div class="violations-modal-header">
                <h2 class="violations-modal-title">üè• Production Health Check</h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="btn-refresh-health" onclick="refreshHealthData()" title="Refresh health data" style="padding: 8px 16px; background: var(--accent-orange); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 6px;">
                        <span id="health-refresh-icon">üîÑ</span>
                        <span>Refresh</span>
                    </button>
                    <button class="btn-close-modal" onclick="closeHealthModal()">√ó</button>
                </div>
            </div>
            <div id="health-details">
                <p style="text-align: center; color: var(--text-tertiary);">Loading health data...</p>
            </div>
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileMenu()"></div>

    <div class="app-container">
        <!-- Sidebar -->
                <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="/static/images/oracare-logo.png" alt="Oracare" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <div class="sidebar-title">Oracare Fulfillment</div>
            </div>
            
            <nav class="sidebar-nav">
                <!-- Primary Navigation -->
                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <a href="/" class="nav-item active">
                        <span class="nav-item-icon">üìä</span>
                        Dashboard
                    </a>
                    <a href="/xml_import.html" class="nav-item">
                        <span class="nav-item-icon">üì•</span>
                        Orders Inbox
                    </a>
                    <a href="/inventory_transactions.html" class="nav-item">
                        <span class="nav-item-icon">üì¶</span>
                        Inventory Monitor
                    </a>
                    <a href="/lot_inventory.html" class="nav-item">
                        <span class="nav-item-icon">üè≠</span>
                        Lot Inventory
                    </a>
                    <a href="/charge_report.html" class="nav-item">
                        <span class="nav-item-icon">üí∞</span>
                        Charge Report
                    </a>
                </div>

                <!-- Admin Section -->
                <div class="nav-section admin-section">
                    <div class="admin-toggle" onclick="toggleAdmin()">
                        <span>Admin & Data</span>
                        <span class="admin-toggle-icon">‚ñ∂</span>
                    </div>
                    <div class="admin-items" id="admin-items">
                        <a href="/order-management.html" class="nav-item">
                            <span class="nav-item-icon">üóëÔ∏è</span>
                            Order Management
                        </a>
                        <a href="/weekly_shipped_history.html" class="nav-item">
                            <span class="nav-item-icon">üìà</span>
                            Weekly Reports
                        </a>
                        <a href="/shipped_orders.html" class="nav-item">
                            <span class="nav-item-icon">üìã</span>
                            Shipped Orders
                        </a>
                        <a href="/order_audit.html" class="nav-item">
                            <span class="nav-item-icon">üîç</span>
                            Order Audit
                        </a>
                        <a href="/shipped_items.html" class="nav-item">
                            <span class="nav-item-icon">üìä</span>
                            Shipped Items
                        </a>
                        <a href="/bundle_skus.html" class="nav-item">
                            <span class="nav-item-icon">üì¶</span>
                            Bundle SKUs
                        </a>
                        <a href="/sku_lot.html" class="nav-item">
                            <span class="nav-item-icon">üè∑Ô∏è</span>
                            SKU Lot Management
                        </a>
                        <a href="/email_contacts.html" class="nav-item">
                            <span class="nav-item-icon">üìß</span>
                            Email Contacts
                        </a>
                        <a href="/workflow_controls.html" class="nav-item">
                            <span class="nav-item-icon">‚öôÔ∏è</span>
                            Workflow Controls
                        </a>
                        <a href="/incidents.html" class="nav-item">
                            <span class="nav-item-icon">üêû</span>
                            Production Bugs
                        </a>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="nav-section" style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: calc(var(--spacing-unit) * 2);">
                    <a href="/help.html" class="nav-item">
                        <span class="nav-item-icon">üìö</span>
                        Help & Training
                    </a>
                    <a href="/settings.html" class="nav-item">
                        <span class="nav-item-icon">‚öôÔ∏è</span>
                        Settings
                    </a>
                </div>

                <!-- User Widget -->
                <div class="user-widget" id="user-widget" style="display: none;">
                    <div class="user-avatar" id="user-avatar">
                        <img id="user-avatar-img" src="" alt="User" style="display: none;">
                        <div id="user-avatar-initials" class="user-avatar-initials"></div>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="user-name">Loading...</div>
                        <div class="user-role-badge" id="user-role-badge">
                            <span id="user-role-text">Viewer</span>
                        </div>
                    </div>
                    <button class="user-logout-btn" onclick="logout()" title="Logout">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 14H3C2.44772 14 2 13.5523 2 13V3C2 2.44772 2.44772 2 3 2H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            <path d="M11 11L14 8M14 8L11 5M14 8H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </nav>
        </aside>


        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <h1 class="page-title">Dashboard</h1>
                </div>
                <div class="top-bar-actions">
                    <span class="last-updated" id="last-updated">Last updated: Just now</span>
                    <button class="btn btn-primary" onclick="window.location.href='/incidents.html#report'" style="margin-right: 8px;">
                        üö® Report Issue
                    </button>
                    <button class="btn" id="refresh-btn" onclick="refreshDashboard()">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8C2 4.68629 4.68629 2 8 2C9.84843 2 11.5098 2.85733 12.5962 4.20803" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                            <path d="M12 2V4.5H9.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Refresh
                    </button>
                    <button class="dark-mode-toggle" onclick="toggleDarkMode()">üåô</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Mobile Quick Actions Dock -->
                <div class="mobile-quick-actions">
                    <a href="/xml_import.html" class="quick-action-btn">
                        <div class="quick-action-icon">üì•</div>
                        <div>Orders<br>Inbox</div>
                    </a>
                    <a href="/shipped_orders.html" class="quick-action-btn">
                        <div class="quick-action-icon">üì¶</div>
                        <div>Shipments</div>
                    </a>
                    <a href="/inventory_transactions.html" class="quick-action-btn">
                        <div class="quick-action-icon">üìä</div>
                        <div>Inventory</div>
                    </a>
                    <a href="/" class="quick-action-btn" onclick="refreshDashboard(); return false;">
                        <div class="quick-action-icon">üîÑ</div>
                        <div>Refresh</div>
                    </a>
                </div>

                <!-- Auto-Ship Day Alert (conditional) -->
                <div id="autoship-alert">
                    <h3><span>üö®</span> <span id="autoship-title">Auto-Ship Day</span></h3>
                    <p id="autoship-message">High volume expected today. Prepare for increased order processing.</p>
                </div>

                <!-- FedEx Alert -->
                <div id="fedex-alert">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
                        <div>
                            <strong id="fedex-alert-title">üöö FedEx Trailer Pickup Needed</strong><br>
                            <span id="fedex-alert-message">185+ units ready for shipment. Call FedEx depot to schedule trailer pickup: <a href="tel:651-846-0590">651-846-0590</a></span>
                        </div>
                        <button id="fedex-complete-btn" onclick="markFedExPickupComplete()" style="padding: 10px 20px; background: #78350f; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                            Mark Completed
                        </button>
                    </div>
                </div>

                <!-- Duplicate Order Alert -->
                <div id="duplicate-alert" style="display: none;">
                    <strong>‚ö†Ô∏è Duplicate Orders Detected in ShipStation</strong><br>
                    <span id="duplicate-count">0</span> order(s) have duplicate records that need attention.
                    <a href="#" onclick="showDuplicateDetails(); return false;" style="text-decoration: underline; margin-left: 10px;">View Details</a>
                </div>

                <!-- Lot Mismatch Alert -->
                <div id="lot-mismatch-alert" style="display: none;">
                    <strong>üî¢ Lot Number Mismatches Detected</strong><br>
                    <span id="lot-mismatch-count">0</span> order(s) have incorrect lot numbers in ShipStation.
                    <a href="#" onclick="showLotMismatchDetails(); return false;" style="text-decoration: underline; margin-left: 10px;">View Details</a>
                </div>

                <!-- Manual Order Conflicts Alert -->
                <div id="manual-order-conflict-alert" style="display: none;">
                    <strong>üîÑ Manual Order Conflicts Detected</strong><br>
                    <span id="manual-order-conflict-count">0</span> manual order(s) use previously shipped order numbers.
                    <a href="#" onclick="showManualOrderConflictDetails(); return false;" style="text-decoration: underline; margin-left: 10px;">View Details</a>
                </div>

                <!-- Operational Pulse Section -->
                <section>
                    <h2 style="font-size: 14px; font-weight: 600; color: var(--text-tertiary); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px;">Operational Pulse</h2>
                    
                    <div class="stats-grid">
                        <!-- Skeleton Loaders -->
                        <div class="skeleton skeleton-card" id="stat-skeleton-1"></div>
                        <div class="skeleton skeleton-card" id="stat-skeleton-2"></div>
                        <div class="skeleton skeleton-card" id="stat-skeleton-3"></div>
                        <div class="skeleton skeleton-card" id="stat-skeleton-4"></div>
                        <div class="skeleton skeleton-card" id="stat-skeleton-5"></div>
                        <div class="skeleton skeleton-card" id="stat-skeleton-6"></div>
                        <div class="skeleton skeleton-card" id="stat-skeleton-7"></div>
                        <div class="skeleton skeleton-card" id="stat-skeleton-8"></div>

                        <!-- Actual Stats -->
                        <!-- ShipStation Count -->
                        <a href="/xml_import.html" style="text-decoration: none; color: inherit;">
                            <div class="stat-card hidden" data-stat-card id="shipstation-card" style="cursor: pointer; position: relative;">
                                <span id="shipstation-badge" class="mismatch-badge" style="display: none;">Mismatch</span>
                                <div class="stat-value" id="shipstation-units">0</div>
                                <div class="stat-label">
                                    ShipStation Units
                                    <span class="help-icon">
                                        <span class="help-tooltip">Units currently in ShipStation awaiting shipment. Updates from ShipStation API every 5 minutes.</span>
                                    </span>
                                </div>
                                <div class="stat-change" id="shipstation-timestamp" style="font-size: 11px; color: var(--text-tertiary);">Loading...</div>
                            </div>
                        </a>
                        <!-- Local DB Count -->
                        <a href="/xml_import.html" style="text-decoration: none; color: inherit;">
                            <div class="stat-card hidden" data-stat-card id="local-db-card" style="cursor: pointer; position: relative;">
                                <span id="local-db-badge" class="mismatch-badge" style="display: none;">Mismatch</span>
                                <div class="stat-value" id="local-db-units">0</div>
                                <div class="stat-label">
                                    Local DB Units
                                    <span class="help-icon">
                                        <span class="help-tooltip">Units in local database ready to upload to ShipStation. Auto-uploads every 5 minutes.</span>
                                    </span>
                                </div>
                                <div class="stat-change" id="local-db-timestamp" style="font-size: 11px; color: var(--text-tertiary);">Loading...</div>
                            </div>
                        </a>
                        <!-- On Hold Count -->
                        <a href="/orders_inbox.html" style="text-decoration: none; color: inherit;">
                            <div class="stat-card hidden" data-stat-card id="on-hold-card" style="cursor: pointer;">
                                <div class="stat-value" id="on-hold-units">0</div>
                                <div class="stat-label">
                                    On Hold Units
                                    <span class="help-icon">
                                        <span class="help-tooltip">Units currently on hold in local database. These orders are paused and not counted as ready to ship.</span>
                                    </span>
                                </div>
                                <div class="stat-change" id="on-hold-timestamp" style="font-size: 11px; color: var(--text-tertiary);">Loading...</div>
                            </div>
                        </a>
                        <a href="/xml_import.html" style="text-decoration: none; color: inherit;">
                            <div class="stat-card hidden" data-stat-card style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div class="stat-value">0</div>
                                <div class="stat-label">
                                    Benco Orders
                                    <span class="help-icon">
                                        <span class="help-tooltip">Special tracking for Benco orders awaiting shipment.</span>
                                    </span>
                                </div>
                                <div class="stat-change">Awaiting Shipment</div>
                            </div>
                        </a>
                        <a href="/xml_import.html" style="text-decoration: none; color: inherit;">
                            <div class="stat-card hidden" data-stat-card style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div class="stat-value">0</div>
                                <div class="stat-label">
                                    Hawaiian Orders
                                    <span class="help-icon">
                                        <span class="help-tooltip">Hawaiian orders awaiting shipment. Must ship via FedEx 2Day.</span>
                                    </span>
                                </div>
                                <div class="stat-change">Awaiting Shipment</div>
                            </div>
                        </a>
                        <a href="/xml_import.html" style="text-decoration: none; color: inherit;">
                            <div class="stat-card hidden" data-stat-card style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div class="stat-value">0</div>
                                <div class="stat-label">Canadian Orders</div>
                                <div class="stat-change">Awaiting Shipment</div>
                            </div>
                        </a>
                        <a href="/xml_import.html" style="text-decoration: none; color: inherit;">
                            <div class="stat-card hidden" data-stat-card style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                <div class="stat-value">0</div>
                                <div class="stat-label">Other International</div>
                                <div class="stat-change">Awaiting Shipment</div>
                            </div>
                        </a>
                        <div class="stat-card hidden" data-stat-card>
                            <div class="stat-value"><span class="status-indicator status-green"></span> Online</div>
                            <div class="stat-label">System Status</div>
                            <div class="stat-change">All services operational</div>
                        </div>
                        <div class="stat-card hidden" data-stat-card id="production-health-card" style="cursor: pointer;" onclick="openHealthModal()">
                            <div class="stat-value" id="prod-health-status">
                                <span class="status-indicator status-gray"></span> Checking...
                            </div>
                            <div class="stat-label">Production Health</div>
                            <div class="stat-change" id="prod-health-detail">Loading...</div>
                        </div>
                    </div>
                </section>

                <!-- Inventory Risk Section -->
                <section>
                    <h2 style="font-size: 14px; font-weight: 600; color: var(--text-tertiary); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px;">Inventory Risk</h2>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <span>üìä</span> Weekly Inventory Report
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn" onclick="copyWeeklyInventoryToClipboard()" id="copyInventoryBtn">
                                    üìß Compose Email
                                </button>
                                <button class="btn" onclick="testEmailClient()" style="background: var(--bg-tertiary); color: var(--text-secondary);">
                                    üß™ Test Email Client
                                </button>
                                <button class="btn" onclick="runEOD()" id="btn-eod">
                                    üì¶ EOD
                                    <div class="btn-status" id="eod-status"></div>
                                </button>
                                <button class="btn" onclick="runEOW()" id="btn-eow">
                                    üìä EOW
                                    <div class="btn-status" id="eow-status"></div>
                                </button>
                                <button class="btn" onclick="runEOM()" id="btn-eom">
                                    üí∞ EOM
                                    <div class="btn-status" id="eom-status"></div>
                                </button>
                            </div>
                        </div>
                        <div id="weeklyReportLoading" style="padding: 20px; text-align: center; color: var(--text-tertiary);">Loading weekly report...</div>
                        <div id="weeklyReportError"></div>
                        <div id="weeklyReportTable" style="display: none; overflow-x: auto; -webkit-overflow-scrolling: touch;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th style="text-align: right;">Current Qty</th>
                                        <th style="text-align: center;">Pallet Breakdown</th>
                                        <th style="text-align: right;">52-Week Avg</th>
                                        <th style="text-align: center;">Days Left</th>
                                        <th style="text-align: center;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="weeklyReportBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Orders Pipeline Section -->
                <section>
                    <h2 style="font-size: 14px; font-weight: 600; color: var(--text-tertiary); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px;">Orders Pipeline</h2>
                    
                    <div class="card" onclick="window.location.href='/xml_import.html'" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                        <div class="card-header">
                            <div class="card-title">
                                <span>üì•</span> Orders Inbox Status
                            </div>
                            <a href="/xml_import.html" class="btn" onclick="event.stopPropagation()">View All Orders ‚Üí</a>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 14px;">
                            <p>Orders are automatically imported from Google Drive every 5 minutes.</p>
                            <p style="margin-top: 8px;">Pending orders are ready for upload to ShipStation.</p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <span>‚öôÔ∏è</span> Automation Status
                            </div>
                        </div>
                        <div id="automation-section">
                            <!-- Skeleton Loaders -->
                            <div class="skeleton" style="height: 60px; border-radius: 8px; margin-bottom: 16px;" id="auto-skeleton-1"></div>
                            <div class="skeleton" style="height: 60px; border-radius: 8px;" id="auto-skeleton-2"></div>
                            
                            <!-- Actual Automation Status -->
                            <div id="automation-list"></div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="/static/timezone-utils.js"></script>
    <script src="/static/shipping-violations-alert.js"></script>
    <script src="/static/dark-mode.js"></script>
    <script src="/static/js/auth.js"></script>

    <script>
        // Global state
        let lastUpdateTime = Date.now();
        let isRefreshing = false;
        let darkMode = localStorage.getItem('darkMode') === 'true';
        let lastKnownTimestamps = {}; // Track workflow timestamps for smart polling

        // Initialize dark mode
        if (darkMode) {
            document.body.classList.add('dark-mode');
            document.querySelector('.dark-mode-toggle').textContent = '‚òÄÔ∏è';
        }

        // Smart polling: Check timestamps and only fetch data when workflows run
        async function checkWorkflowTimestamps() {
            try {
                const response = await fetch('/api/workflow_timestamps');
                const result = await response.json();
                
                if (!result.success || !result.timestamps) return;
                
                const currentTimestamps = result.timestamps;
                let hasChanges = false;
                
                // Check if any workflow timestamp changed
                for (const [workflow, timestamp] of Object.entries(currentTimestamps)) {
                    if (!lastKnownTimestamps[workflow] || lastKnownTimestamps[workflow] !== timestamp) {
                        hasChanges = true;
                        break;
                    }
                }
                
                // Only fetch full data if workflows actually ran
                if (hasChanges) {
                    console.log('üìä Workflows updated - fetching fresh data');
                    lastKnownTimestamps = currentTimestamps;
                    await loadDashboardData();
                    lastUpdateTime = Date.now();
                }
            } catch (error) {
                console.error('Timestamp check failed:', error);
                // Fallback: load data anyway if check fails
                await loadDashboardData();
            }
        }

        // Toggle dark mode
        // Toggle admin section
        function toggleAdmin() {
            const toggle = document.querySelector('.admin-toggle');
            const items = document.getElementById('admin-items');
            toggle.classList.toggle('expanded');
            items.classList.toggle('expanded');
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        // Close mobile menu
        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }

        // Update timestamp display
        function updateTimestamp() {
            const now = Date.now();
            const diff = Math.floor((now - lastUpdateTime) / 1000);
            const timestampEl = document.getElementById('last-updated');
            
            if (diff < 60) {
                timestampEl.textContent = 'Last updated: Just now';
            } else if (diff < 3600) {
                const minutes = Math.floor(diff / 60);
                timestampEl.textContent = `Last updated: ${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            } else {
                const hours = Math.floor(diff / 3600);
                timestampEl.textContent = `Last updated: ${hours} hour${hours > 1 ? 's' : ''} ago`;
            }
        }

        // Show/hide skeletons
        function showSkeletons() {
            for (let i = 1; i <= 8; i++) {
                document.getElementById(`stat-skeleton-${i}`).classList.remove('hidden');
            }
            document.querySelectorAll('[data-stat-card]').forEach(el => el.classList.add('hidden'));
            
            for (let i = 1; i <= 2; i++) {
                document.getElementById(`auto-skeleton-${i}`).classList.remove('hidden');
            }
        }

        function hideSkeletons() {
            for (let i = 1; i <= 8; i++) {
                document.getElementById(`stat-skeleton-${i}`).classList.add('hidden');
            }
            document.querySelectorAll('[data-stat-card]').forEach(el => el.classList.remove('hidden'));
            
            for (let i = 1; i <= 2; i++) {
                document.getElementById(`auto-skeleton-${i}`).classList.add('hidden');
            }
        }

        // HTML escape helper
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load weekly inventory report
        async function loadWeeklyReport() {
            const loadingDiv = document.getElementById('weeklyReportLoading');
            const errorDiv = document.getElementById('weeklyReportError');
            const tableDiv = document.getElementById('weeklyReportTable');
            const tbody = document.getElementById('weeklyReportBody');
            
            try {
                loadingDiv.style.display = 'block';
                errorDiv.innerHTML = '';
                tableDiv.style.display = 'none';
                
                const response = await fetch('/api/weekly_inventory_report');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load weekly report');
                }
                
                tbody.innerHTML = result.data.map(item => {
                    const daysLeft = item.days_left || 0;
                    const statusClass = daysLeft < 14 ? 'critical' : 
                                       daysLeft < 30 ? 'warning' : 'success';
                    const statusIcon = daysLeft < 14 ? 'üî¥' : 
                                      daysLeft < 30 ? 'üü°' : 'üü¢';
                    const daysText = daysLeft >= 999 ? '‚àû' : daysLeft;
                    
                    // Format pallet breakdown for physical inventory check
                    const palletBreakdown = item.partial_units > 0 
                        ? `${item.full_pallets} full + ${item.partial_units} units` 
                        : `${item.full_pallets} full`;
                    
                    return `
                        <tr>
                            <td>
                                <strong>${item.product_name || item.sku}</strong>
                                <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 2px;">SKU: ${item.sku}</div>
                            </td>
                            <td style="text-align: right;"><strong>${item.current_quantity}</strong></td>
                            <td style="text-align: center;">
                                <span style="font-family: monospace; color: var(--text-secondary);">
                                    üì¶ ${palletBreakdown}
                                </span>
                            </td>
                            <td style="text-align: right;">${item.rolling_avg_52_weeks}</td>
                            <td style="text-align: center;">
                                <span class="badge badge-${statusClass}">
                                    <span class="status-indicator status-${statusClass === 'critical' ? 'red' : statusClass === 'warning' ? 'yellow' : 'green'}"></span>
                                    ${daysText} days
                                </span>
                            </td>
                            <td style="text-align: center;">
                                <button class="btn-icon" onclick="openPhysicalCountModal('${item.sku}', ${item.current_quantity}, '${item.product_name}')" title="Adjust inventory from physical count">
                                    ‚úèÔ∏è Adjust
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                loadingDiv.style.display = 'none';
                tableDiv.style.display = 'block';
            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.innerHTML = `<div style="padding: 20px; background: var(--bg-tertiary); color: var(--critical-red); border-radius: 8px;">Failed to load weekly report: ${error.message}</div>`;
            }
        }

        // Refresh weekly report
        async function refreshWeeklyReport() {
            const btn = document.getElementById('weeklyReportRefreshBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Refreshing...';
            
            try {
                await loadWeeklyReport();
                btn.textContent = '‚úÖ Refreshed!';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Refresh';
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                btn.textContent = '‚ùå Failed';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Refresh';
                    btn.disabled = false;
                }, 2000);
            }
        }

        // Copy weekly inventory to clipboard
        async function copyWeeklyInventoryToClipboard() {
            const btn = document.getElementById('copyInventoryBtn');
            const originalText = btn.textContent;
            
            try {
                btn.disabled = true;
                btn.textContent = '‚è≥ Copying...';
                
                const response = await fetch('/api/weekly_inventory_report');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load weekly report');
                }
                
                const htmlRows = result.data.map(item => {
                    const daysLeft = item.days_left >= 999 ? '‚àû' : item.days_left;
                    const productName = item.product_name || item.sku;
                    return `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">
                            <strong>${escapeHtml(String(productName))}</strong><br>
                            <span style="font-size: 0.85em; color: #666;">SKU: ${escapeHtml(String(item.sku))}</span>
                        </td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${escapeHtml(String(item.current_quantity))}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${escapeHtml(String(item.rolling_avg_52_weeks))}</td>
                        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${escapeHtml(String(daysLeft))}</td>
                    </tr>
                `;}).join('');
                
                const htmlTable = `
                    <table style="border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; font-size: 14px;">
                        <thead>
                            <tr style="background-color: #f3f4f6;">
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Product</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Current Qty</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">52-Week Avg</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">Days Left</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${htmlRows}
                        </tbody>
                    </table>
                `;
                
                const plainHeader = 'Product                    | SKU   | Current Qty | 52-Week Avg | Days Left';
                const plainSeparator = '-'.repeat(80);
                const plainRows = result.data.map(item => {
                    const productName = (item.product_name || item.sku).padEnd(25);
                    const sku = String(item.sku).padEnd(6);
                    const current = String(item.current_quantity).padStart(11);
                    const avg = String(item.rolling_avg_52_weeks).padStart(11);
                    const daysLeft = item.days_left >= 999 ? '‚àû' : String(item.days_left);
                    const daysLeftPadded = daysLeft.padStart(9);
                    return `${productName} | ${sku} | ${current} | ${avg} | ${daysLeftPadded}`;
                }).join('\n');
                const plainText = `${plainHeader}\n${plainSeparator}\n${plainRows}`;
                
                // First, copy to clipboard (must complete before opening mailto)
                try {
                    const htmlBlob = new Blob([htmlTable], { type: 'text/html' });
                    const plainBlob = new Blob([plainText], { type: 'text/plain' });
                    const clipboardItem = new ClipboardItem({
                        'text/html': htmlBlob,
                        'text/plain': plainBlob
                    });
                    await navigator.clipboard.write([clipboardItem]);
                } catch (htmlError) {
                    console.warn('HTML clipboard not supported, falling back to plain text:', htmlError);
                    try {
                        await navigator.clipboard.writeText(plainText);
                    } catch (textError) {
                        console.error('Clipboard write failed:', textError);
                        throw new Error('Failed to copy to clipboard. Please try again.');
                    }
                }
                
                btn.textContent = '‚úÖ Copied!';
                
                // Wait a moment to ensure clipboard is ready
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Fetch email contacts and compose email
                try {
                    const contactsResponse = await fetch('/api/email_contacts');
                    const contactsData = await contactsResponse.json();
                    
                    if (contactsData.success && contactsData.data && contactsData.data.length > 0) {
                        // Get all email addresses
                        const emailList = contactsData.data.map(c => c.email).join(',');
                        
                        btn.textContent = 'üìß Ready!';
                        
                        // Open email client with BCC recipients (no body due to size limits)
                        const subject = 'Weekly Inventory Report - Oracare';
                        const mailtoLink = `mailto:?bcc=${encodeURIComponent(emailList)}&subject=${encodeURIComponent(subject)}`;
                        
                        // Open email client FIRST (while user interaction is fresh)
                        const link = document.createElement('a');
                        link.href = mailtoLink;
                        link.target = '_blank';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // Show instructions AFTER opening email (prevents popup blocker)
                        setTimeout(() => {
                            alert(`‚úÖ Email client opened!\n\nThe report has been copied to your clipboard.\n\nNow:\n1. Your email client should have opened with ${contactsData.data.length} BCC recipients\n2. Paste the report into the email body (Ctrl+V or Cmd+V)\n3. Send!`);
                        }, 500);
                        
                        // Reset button
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.disabled = false;
                        }, 2000);
                    } else {
                        alert('‚ö†Ô∏è No email contacts found. Please add contacts in the Email Contacts page first.');
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.disabled = false;
                        }, 2000);
                    }
                } catch (emailError) {
                    console.error('Failed to get email contacts:', emailError);
                    alert('‚ùå Failed to load email contacts. Please try again.');
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (error) {
                console.error('Failed to copy to clipboard:', error);
                btn.textContent = '‚ùå Failed';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        // Test email client functionality
        async function testEmailClient() {
            try {
                // Fetch email contacts
                const response = await fetch('/api/email_contacts');
                const data = await response.json();
                
                if (!data.success || !data.data || data.data.length === 0) {
                    alert('‚ö†Ô∏è No email contacts found. Please add contacts in the Email Contacts page first.');
                    return;
                }
                
                // Get all email addresses
                const emailList = data.data.map(c => c.email).join(',');
                
                // Create a simple test mailto link
                const subject = 'Test Email - Weekly Inventory Report';
                const body = 'This is a test email from the Oracare Fulfillment System.';
                const mailtoLink = `mailto:?bcc=${encodeURIComponent(emailList)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                console.log('Opening mailto link:', mailtoLink);
                
                // Try to open email client
                const link = document.createElement('a');
                link.href = mailtoLink;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show success message
                setTimeout(() => {
                    alert(`‚úÖ Email client test initiated!\n\nIf your email client opened with ${data.data.length} contacts in BCC, the feature works!\n\nIf nothing happened, your browser may be blocking mailto: links or you don't have a default email client configured.`);
                }, 500);
                
            } catch (error) {
                console.error('Error testing email client:', error);
                const errorMsg = error?.message || error?.toString() || 'Unknown error';
                alert('‚ùå Failed to test email client: ' + errorMsg);
            }
        }

        // Helper function to format relative time
        function formatRelativeTime(timestamp) {
            if (!timestamp) return 'Never';
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return then.toLocaleDateString();
        }

        // Update production health card
        async function updateProductionHealth() {
            try {
                const response = await fetch('/health');
                const health = await response.json();
                
                const statusEl = document.getElementById('prod-health-status');
                const detailEl = document.getElementById('prod-health-detail');
                
                const isProd = health.environment === 'PRODUCTION';
                const workflowsOk = health.workflows && health.workflows.some(w => w.enabled && w.age_minutes < 30);
                
                let statusHTML, detailText, statusClass;
                
                if (isProd && workflowsOk) {
                    statusHTML = '<span class="status-indicator status-green"></span> Healthy';
                    detailText = 'Production workflows running';
                    statusClass = 'status-green';
                } else if (isProd && !workflowsOk) {
                    statusHTML = '<span class="status-indicator status-red"></span> Warning';
                    detailText = 'Workflows may be stale';
                    statusClass = 'status-red';
                } else {
                    statusHTML = '<span class="status-indicator status-yellow"></span> Dev Mode';
                    detailText = 'Development environment';
                    statusClass = 'status-yellow';
                }
                
                statusEl.innerHTML = statusHTML;
                detailEl.textContent = detailText;
            } catch (error) {
                console.error('Failed to fetch production health:', error);
                document.getElementById('prod-health-status').innerHTML = 
                    '<span class="status-indicator status-gray"></span> Unknown';
                document.getElementById('prod-health-detail').textContent = 'Click to check';
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                const [statsRes, alertsRes, automationRes, shipstationRes, localDbRes, onHoldRes, lotMismatchRes] = await Promise.all([
                    fetch('/api/dashboard_stats'),
                    fetch('/api/inventory_alerts'),
                    fetch('/api/automation_status'),
                    fetch('/api/shipstation/units_to_ship'),
                    fetch('/api/local/awaiting_shipment_count'),
                    fetch('/api/local/on_hold_count'),
                    fetch('/api/lot_mismatch_count'),
                    updateProductionHealth()  // Add production health check
                ]);
                
                const stats = await statsRes.json();
                const alerts = await alertsRes.json();
                const automation = await automationRes.json();
                const shipstation = await shipstationRes.json();
                const localDb = await localDbRes.json();
                const onHold = await onHoldRes.json();
                const lotMismatch = await lotMismatchRes.json();
                
                // Update ShipStation card independently
                let ssUnits = 0;
                if (shipstation.success) {
                    ssUnits = shipstation.units_to_ship || 0;
                    document.getElementById('shipstation-units').textContent = ssUnits;
                    document.getElementById('shipstation-timestamp').textContent = 
                        'Updated: ' + formatRelativeTime(shipstation.last_updated);
                }
                
                // Update Local DB card independently
                let localUnits = 0;
                if (localDb.success) {
                    localUnits = localDb.total_units || 0;
                    document.getElementById('local-db-units').textContent = localUnits;
                    document.getElementById('local-db-timestamp').textContent = 
                        'Updated: ' + formatRelativeTime(localDb.last_updated);
                }
                
                // Update On Hold card independently
                if (onHold.success) {
                    document.getElementById('on-hold-units').textContent = onHold.total_units || 0;
                    document.getElementById('on-hold-timestamp').textContent = 
                        'Updated: ' + formatRelativeTime(onHold.last_updated);
                }
                
                // Update Lot Mismatch card independently
                if (lotMismatch.success) {
                    const lotMismatchCount = lotMismatch.count || 0;
                    const lotMismatchElement = document.getElementById('lot-mismatch-orders');
                    if (lotMismatchElement) {
                        lotMismatchElement.textContent = lotMismatchCount;
                    }
                    
                    // Show/hide card based on count
                    const lotMismatchCard = document.getElementById('lot-mismatch-card');
                    if (lotMismatchCard) {
                        if (lotMismatchCount > 0) {
                            lotMismatchCard.style.backgroundColor = 'rgba(245, 158, 11, 0.1)';
                            lotMismatchCard.style.borderLeft = '4px solid #f59e0b';
                        } else {
                            lotMismatchCard.style.backgroundColor = '';
                            lotMismatchCard.style.borderLeft = '';
                        }
                    }
                }
                
                // Mismatch detection only if BOTH APIs succeeded
                if (shipstation.success && localDb.success) {
                    const mismatch = ssUnits !== localUnits;
                    const ssBadge = document.getElementById('shipstation-badge');
                    const localBadge = document.getElementById('local-db-badge');
                    
                    if (mismatch) {
                        ssBadge.style.display = 'block';
                        localBadge.style.display = 'block';
                    } else {
                        ssBadge.style.display = 'none';
                        localBadge.style.display = 'none';
                    }
                }
                
                // Update stats cards (note: index 2 is now on-hold-card)
                if (stats.success) {
                    const statCards = document.querySelectorAll('[data-stat-card]');
                    if (statCards[3]) statCards[3].querySelector('.stat-value').textContent = stats.data.benco_orders || 0;
                    if (statCards[4]) statCards[4].querySelector('.stat-value').textContent = stats.data.hawaiian_orders || 0;
                    if (statCards[5]) statCards[5].querySelector('.stat-value').textContent = stats.data.canadian_orders || 0;
                    if (statCards[6]) statCards[6].querySelector('.stat-value').textContent = stats.data.other_international_orders || 0;
                    if (statCards[7]) {
                        // Enhanced system status with real-time workflow health
                        let statusText, statusClass, statusMessage;
                        
                        if (stats.data.system_status === 'operational') {
                            statusText = 'Online';
                            statusClass = 'status-green';
                            statusMessage = stats.data.system_message || 'All services operational';
                        } else if (stats.data.system_status === 'error') {
                            statusText = 'Error';
                            statusClass = 'status-red';
                            statusMessage = stats.data.system_message || 'System errors detected';
                        } else {
                            statusText = 'Warning';
                            statusClass = 'status-yellow';
                            statusMessage = stats.data.system_message || 'No recent activity';
                        }
                        
                        statCards[7].querySelector('.stat-value').innerHTML = `<span class="status-indicator ${statusClass}"></span> ${statusText}`;
                        statCards[7].querySelector('.stat-change').textContent = statusMessage;
                    }
                    
                    const fedexAlert = document.getElementById('fedex-alert');
                    const fedexTitle = document.getElementById('fedex-alert-title');
                    const fedexMessage = document.getElementById('fedex-alert-message');
                    const fedexBtn = document.getElementById('fedex-complete-btn');
                    
                    if (stats.data.fedex_pickup_needed) {
                        if (stats.data.fedex_pickup_completed) {
                            // Show completion status
                            fedexTitle.textContent = '‚úÖ FedEx Pickup Completed';
                            // Parse UTC timestamp and convert to local time
                            const completedTime = new Date(stats.data.fedex_pickup_completed_at + 'Z');
                            const localTime = completedTime.toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit',
                                hour12: true 
                            });
                            fedexMessage.textContent = `Pickup scheduled at ${localTime}`;
                            fedexBtn.style.display = 'none';
                            fedexAlert.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                            fedexAlert.style.color = 'white';
                        } else {
                            // Show pending status
                            fedexTitle.textContent = 'üöö FedEx Trailer Pickup Needed';
                            fedexMessage.innerHTML = '185+ units ready for shipment. Call FedEx depot to schedule trailer pickup: <a href="tel:651-846-0590" style="color: #78350f; font-weight: 600; text-decoration: underline;">651-846-0590</a>';
                            fedexBtn.style.display = 'block';
                            fedexAlert.style.background = 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)';
                            fedexAlert.style.color = '#78350f';
                        }
                        fedexAlert.style.display = 'block';
                    } else {
                        fedexAlert.style.display = 'none';
                    }
                }
                
                // Check for duplicate order alerts
                await checkDuplicateAlerts();
                
                // Check for lot mismatch alerts
                await checkLotMismatchAlerts();
                
                // Check for manual order conflicts
                await checkManualOrderConflicts();
                
                // Update automation status
                if (automation.success && automation.data.length > 0) {
                    const autoList = document.getElementById('automation-list');
                    autoList.innerHTML = automation.data.map(item => {
                        const statusClass = item.status === 'success' ? 'success' : item.status === 'running' ? 'warning' : 'critical';
                        const icon = item.status === 'success' ? '‚úÖ' : item.status === 'running' ? '‚è≥' : '‚ùå';
                        return `
                            <div style="padding: 16px; border-radius: 8px; background: var(--bg-tertiary); margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div>
                                        <strong>${item.name}</strong><br>
                                        <span style="font-size: 13px; color: var(--text-secondary);">Last run: ${item.last_run || 'Never'}</span>
                                    </div>
                                    <span class="badge badge-${statusClass}">
                                        <span>${icon}</span>
                                        ${item.status}
                                    </span>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('automation-list').innerHTML = '<p style="color: var(--text-tertiary); text-align: center; padding: 20px;">No automation data</p>';
                }
                
                // Re-check auto-ship day status (updates in real-time)
                checkAutoShipDay();
                
                hideSkeletons();
                lastUpdateTime = Date.now();
                updateTimestamp();
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }

        // Refresh dashboard
        async function refreshDashboard() {
            if (isRefreshing) return;
            isRefreshing = true;
            
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            
            showSkeletons();
            
            try {
                // Refresh ShipStation metrics first (prevent stale cache)
                await fetch('/api/shipstation/refresh_units_to_ship', { method: 'POST' });
                
                // Then load all dashboard data
                await Promise.all([
                    loadDashboardData(),
                    loadWeeklyReport()
                ]);
            } finally {
                isRefreshing = false;
                btn.disabled = false;
            }
        }

        // Smart polling: Check workflow timestamps every 5 seconds
        // Only fetch full data when workflows actually run (event-driven)
        setInterval(() => {
            if (!document.hidden) {
                checkWorkflowTimestamps();
            }
        }, 5000);

        // Update timestamp display every 5 seconds
        setInterval(updateTimestamp, 5000);

        // Close mobile menu on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeMobileMenu();
            }
        });

        // Close mobile menu when clicking nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 1024) {
                    closeMobileMenu();
                }
            });
        });

        // Check for Auto-Ship Day
        function checkAutoShipDay() {
            const today = new Date();
            const dayOfMonth = today.getDate();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 6 = Saturday
            
            const autoShipDays = [5, 15, 25];
            const isAutoShipDay = autoShipDays.includes(dayOfMonth);
            const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
            
            const alert = document.getElementById('autoship-alert');
            const title = document.getElementById('autoship-title');
            const message = document.getElementById('autoship-message');
            
            if (isAutoShipDay) {
                if (isWeekend) {
                    // Weekend auto-ship day
                    const dayName = dayOfWeek === 0 ? 'Sunday' : 'Saturday';
                    alert.classList.add('weekend-notice');
                    title.textContent = `Auto-Ship Day (${dayName})`;
                    message.textContent = `Today is the ${dayOfMonth}${getDaySuffix(dayOfMonth)}, a scheduled auto-ship day falling on ${dayName}. High volume orders may have been processed Friday or will process Monday.`;
                } else {
                    // Regular auto-ship day
                    alert.classList.remove('weekend-notice');
                    title.textContent = `üö® Auto-Ship Day - ${getDayName(dayOfWeek)}`;
                    message.textContent = `Today is the ${dayOfMonth}${getDaySuffix(dayOfMonth)} - a high-volume auto-ship day. Expect increased order processing and shipment volume.`;
                }
                alert.style.display = 'block';
            } else {
                alert.style.display = 'none';
            }
        }
        
        function getDaySuffix(day) {
            if (day >= 11 && day <= 13) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }
        
        function getDayName(dayOfWeek) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[dayOfWeek];
        }

        // Duplicate Alert Functions
        let duplicateAlertsData = [];
        
        async function checkDuplicateAlerts() {
            try {
                const response = await fetch('/api/duplicate_alerts');
                const data = await response.json();
                
                if (data.success && data.count > 0) {
                    duplicateAlertsData = data.alerts;
                    const duplicateAlert = document.getElementById('duplicate-alert');
                    const duplicateCount = document.getElementById('duplicate-count');
                    duplicateCount.textContent = data.count;
                    duplicateAlert.style.display = 'block';
                } else {
                    document.getElementById('duplicate-alert').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking duplicate alerts:', error);
            }
        }
        
        function showDuplicateDetails() {
            if (duplicateAlertsData.length === 0) {
                alert('No duplicate alerts to display');
                return;
            }
            
            let html = '<div style="max-width: 800px; max-height: 70vh; overflow-y: auto;">';
            html += '<h3 style="margin-top: 0;">Duplicate Orders in ShipStation</h3>';
            html += '<p style="color: var(--text-secondary); margin-bottom: 20px;">The following orders have multiple records in ShipStation and need to be resolved:</p>';
            
            duplicateAlertsData.forEach((alert, idx) => {
                html += '<div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #f97316;">';
                html += `<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">`;
                html += `<div><strong style="font-size: 16px;">Order #${alert.order_number} + SKU ${alert.base_sku || 'N/A'}</strong><br>`;
                html += `<span style="color: var(--text-tertiary); font-size: 13px;">Found ${alert.duplicate_count} duplicate records</span><br>`;
                
                // Show ShipStation IDs in header
                if (alert.shipstation_ids && alert.shipstation_ids.length > 0) {
                    html += `<span style="color: var(--text-tertiary); font-size: 12px; font-family: monospace;">ShipStation IDs: ${alert.shipstation_ids.join(', ')}</span>`;
                }
                
                html += `</div>`;
                html += `<button onclick="resolveDuplicateAlert(${alert.id}, '${alert.order_number}', '${alert.base_sku || 'N/A'}')" style="padding: 6px 12px; background: #22c55e; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">Mark Resolved</button>`;
                html += '</div>';
                
                // Show details of each duplicate from ShipStation
                if (alert.details && alert.details.length > 0) {
                    html += '<div style="margin-bottom: 12px;"><strong style="font-size: 14px;">ShipStation Records:</strong></div>';
                    html += '<table style="width: 100%; font-size: 13px; margin-top: 8px; border-collapse: collapse;">';
                    html += '<thead><tr style="background: #eff6ff; text-align: left;"><th style="padding: 8px;">Data Source</th><th style="padding: 8px;">Order #</th><th style="padding: 8px;">SS ID</th><th style="padding: 8px;">SKU</th><th style="padding: 8px;">Qty</th><th style="padding: 8px;">Customer</th><th style="padding: 8px;">Status</th><th style="padding: 8px;">Created</th><th style="padding: 8px;">Action</th></tr></thead>';
                    html += '<tbody>';
                    alert.details.forEach(detail => {
                        html += '<tr style="border-bottom: 1px solid var(--border-color); background: #eff6ff;">';
                        html += `<td style="padding: 8px;"><span style="background: #2563eb; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">ShipStation</span></td>`;
                        html += `<td style="padding: 8px; font-weight: 600;">${alert.order_number}</td>`;
                        html += `<td style="padding: 8px; font-family: monospace;">${detail.shipstation_id}</td>`;
                        html += `<td style="padding: 8px;">${detail.full_sku || detail.base_sku || 'N/A'}</td>`;
                        html += `<td style="padding: 8px;">${detail.quantity || 0}</td>`;
                        html += `<td style="padding: 8px;">${detail.customer_name || 'N/A'}</td>`;
                        html += `<td style="padding: 8px;">${detail.order_status}</td>`;
                        html += `<td style="padding: 8px;">${new Date(detail.create_date).toLocaleString()}</td>`;
                        html += `<td style="padding: 8px;"><button onclick="deleteDuplicateOrder(event, ${detail.shipstation_id}, '${alert.order_number}', ${alert.id})" style="padding: 4px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">üóëÔ∏è Delete</button></td>`;
                        html += '</tr>';
                    });
                    html += '</tbody></table>';
                }
                
                // Show local database matches
                if (alert.local_matches && alert.local_matches.length > 0) {
                    html += '<div style="margin-top: 16px; margin-bottom: 8px;"><strong style="font-size: 14px;">Local Database Records:</strong></div>';
                    html += '<table style="width: 100%; font-size: 13px; border-collapse: collapse;">';
                    html += '<thead><tr style="background: #f0fdf4; text-align: left;"><th style="padding: 8px;">Data Source</th><th style="padding: 8px;">Order #</th><th style="padding: 8px;">SS ID</th><th style="padding: 8px;">Customer</th><th style="padding: 8px;">Company</th><th style="padding: 8px;">Status</th><th style="padding: 8px;">Items</th><th style="padding: 8px;">Created</th><th style="padding: 8px;">Action</th></tr></thead>';
                    html += '<tbody>';
                    alert.local_matches.forEach(match => {
                        const items = match.items.map(item => {
                            const lot = item.sku_lot ? ` - ${item.sku_lot}` : '';
                            return `${item.sku}${lot} (${item.quantity})`;
                        }).join(', ');
                        
                        const ssIdDisplay = match.shipstation_order_id || '<span style="color: var(--text-tertiary); font-style: italic;">Not Linked</span>';
                        const hasItems = match.items && match.items.length > 0;
                        const itemsDisplay = hasItems ? items : '<span style="color: #dc2626; font-weight: 600;">No items</span>';
                        
                        html += '<tr style="border-bottom: 1px solid var(--border-color); background: #f0fdf4;">';
                        html += `<td style="padding: 8px;"><span style="background: #16a34a; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">Local DB</span></td>`;
                        html += `<td style="padding: 8px; font-weight: 600;">${match.order_number}</td>`;
                        html += `<td style="padding: 8px; font-family: monospace;">${ssIdDisplay}</td>`;
                        html += `<td style="padding: 8px;">${match.ship_name || 'N/A'}</td>`;
                        html += `<td style="padding: 8px;">${match.ship_company || 'N/A'}</td>`;
                        html += `<td style="padding: 8px;">${match.status}</td>`;
                        html += `<td style="padding: 8px; font-size: 11px;">${itemsDisplay}</td>`;
                        html += `<td style="padding: 8px;">${match.created_at ? new Date(match.created_at).toLocaleDateString() : 'N/A'}</td>`;
                        
                        // Add Sync Items button if no items
                        if (!hasItems && match.shipstation_order_id) {
                            html += `<td style="padding: 8px;"><button onclick="syncOrderItems(event, ${match.id}, '${match.order_number}')" style="padding: 4px 10px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">üîÑ Sync Items</button></td>`;
                        } else {
                            html += `<td style="padding: 8px;">-</td>`;
                        }
                        
                        html += '</tr>';
                    });
                    html += '</tbody></table>';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `<div style="background: var(--bg-primary); border-radius: 12px; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-width: 900px; width: 100%;">${html}<button onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px; padding: 12px 24px; background: var(--primary-navy); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button></div>`;
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        async function deleteDuplicateOrder(event, shipstationOrderId, orderNumber, alertId) {
            if (!confirm(`‚ö†Ô∏è Delete order #${orderNumber} (ShipStation ID: ${shipstationOrderId}) from ShipStation?\n\nThis action cannot be undone!`)) {
                return;
            }
            
            const btn = event.target;
            const row = btn.closest('tr');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Deleting...';
            
            try {
                const response = await fetch(`/api/duplicate_alerts/delete_order/${shipstationOrderId}`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update the row to show it's been deleted
                    row.style.opacity = '0.5';
                    row.style.textDecoration = 'line-through';
                    row.style.background = '#fee2e2';
                    
                    // Replace Delete button with Deleted status
                    btn.innerHTML = '‚úÖ Deleted';
                    btn.style.background = '#6b7280';
                    btn.style.cursor = 'default';
                    btn.disabled = true;
                    
                    // Show brief success message
                    const statusMsg = document.createElement('div');
                    statusMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; font-weight: 600;';
                    statusMsg.textContent = `‚úÖ Order ${shipstationOrderId} deleted from ShipStation`;
                    document.body.appendChild(statusMsg);
                    
                    setTimeout(() => {
                        statusMsg.style.transition = 'opacity 0.3s';
                        statusMsg.style.opacity = '0';
                        setTimeout(() => statusMsg.remove(), 300);
                    }, 3000);
                    
                    // Refresh alert count in background
                    await checkDuplicateAlerts();
                } else {
                    throw new Error(result.error || 'Failed to delete order');
                }
            } catch (error) {
                console.error('Error deleting duplicate order:', error);
                alert('‚ùå Error deleting order: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
        
        async function resolveDuplicateAlert(alertId, orderNumber, baseSku) {
            const displayText = baseSku && baseSku !== 'N/A' 
                ? `order #${orderNumber} + SKU ${baseSku}` 
                : `order #${orderNumber}`;
            if (!confirm(`Mark ${displayText} duplicate alert as resolved?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/duplicate_alerts/${alertId}/resolve`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({notes: 'Resolved via dashboard'})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Duplicate alert resolved');
                    // Refresh alerts
                    await checkDuplicateAlerts();
                    // Close modal if exists
                    const modal = document.querySelector('div[style*="z-index: 9999"]');
                    if (modal) modal.remove();
                } else {
                    throw new Error(result.error || 'Failed to resolve alert');
                }
            } catch (error) {
                console.error('Error resolving duplicate alert:', error);
                alert('Error resolving alert: ' + error.message);
            }
        }
        
        async function syncOrderItems(event, orderInboxId, orderNumber) {
            if (!confirm(`üîÑ Sync items from ShipStation for order #${orderNumber}?\n\nThis will fetch the order's items from ShipStation and update your local database.`)) {
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Syncing...';
            
            try {
                const response = await fetch(`/api/duplicate_alerts/sync_items/${orderInboxId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ ${result.message}`);
                    // Refresh alerts to show updated data
                    await checkDuplicateAlerts();
                    // Close and reopen modal to show updated items
                    const modal = document.querySelector('div[style*="z-index: 9999"]');
                    if (modal) {
                        modal.remove();
                        // Wait for alert data to refresh
                        setTimeout(() => showDuplicateDetails(), 500);
                    }
                } else {
                    throw new Error(result.error || 'Failed to sync items');
                }
            } catch (error) {
                console.error('Error syncing order items:', error);
                alert('‚ùå Error syncing items: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Lot Mismatch Alert Functions
        let lotMismatchAlertsData = [];
        
        async function checkLotMismatchAlerts() {
            try {
                const response = await fetch('/api/lot_mismatch_alerts');
                const data = await response.json();
                
                if (data.success && data.count > 0) {
                    lotMismatchAlertsData = data.alerts;
                    const lotMismatchAlert = document.getElementById('lot-mismatch-alert');
                    const lotMismatchCount = document.getElementById('lot-mismatch-count');
                    lotMismatchCount.textContent = data.count;
                    lotMismatchAlert.style.display = 'block';
                } else {
                    document.getElementById('lot-mismatch-alert').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking lot mismatch alerts:', error);
            }
        }
        
        function showLotMismatchDetails() {
            if (lotMismatchAlertsData.length === 0) {
                alert('No lot mismatch alerts to display');
                return;
            }
            
            let html = '<div style="max-width: 900px; max-height: 75vh; overflow-y: auto;">';
            html += '<div style="position: sticky; top: 0; background: var(--bg-primary); z-index: 10; padding-bottom: 16px; border-bottom: 2px solid var(--border-color); margin-bottom: 20px;">';
            html += '<h3 style="margin-top: 0; margin-bottom: 8px;">Lot Number Mismatches</h3>';
            html += '<p style="color: var(--text-secondary); margin-bottom: 16px;">Select multiple orders to update at once.</p>';
            
            // Bulk action header
            html += '<div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">';
            html += '<label style="display: flex; align-items: center; gap: 8px; font-weight: 600; cursor: pointer;">';
            html += '<input type="checkbox" id="select-all-lots" onchange="toggleAllLotCheckboxes()" style="width: 18px; height: 18px; cursor: pointer;">';
            html += '<span>Select All</span>';
            html += '</label>';
            html += '<span id="selected-count" style="color: var(--text-tertiary); font-size: 14px;">0 selected</span>';
            html += '<button id="bulk-update-btn" onclick="bulkUpdateLots()" disabled style="padding: 10px 20px; background: var(--accent-orange); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; opacity: 0.5;">üîß Update Selected</button>';
            html += '<button id="bulk-resolve-btn" onclick="bulkResolveLots()" disabled style="padding: 10px 20px; background: var(--text-tertiary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; opacity: 0.5;">‚úì Resolve Selected</button>';
            html += '</div>';
            html += '</div>';
            
            // Consolidated Table View
            html += '<div style="overflow-x: auto;">';
            html += '<table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
            html += '<thead>';
            html += '<tr style="background: var(--bg-tertiary); border-bottom: 2px solid var(--border-color);">';
            html += '<th style="padding: 12px 8px; text-align: center; width: 40px;"></th>';
            html += '<th style="padding: 12px 8px; text-align: left; font-weight: 600;">Order #</th>';
            html += '<th style="padding: 12px 8px; text-align: left; font-weight: 600;">SKU</th>';
            html += '<th style="padding: 12px 8px; text-align: left; font-weight: 600;">ShipStation Lot</th>';
            html += '<th style="padding: 12px 8px; text-align: left; font-weight: 600;">Active Lot</th>';
            html += '<th style="padding: 12px 8px; text-align: left; font-weight: 600;">Status</th>';
            html += '<th style="padding: 12px 8px; text-align: left; font-weight: 600;">Detected</th>';
            html += '<th style="padding: 12px 8px; text-align: center; font-weight: 600; width: 120px;">Action</th>';
            html += '</tr>';
            html += '</thead>';
            html += '<tbody>';
            
            lotMismatchAlertsData.forEach((alert, index) => {
                const rowStyle = index % 2 === 0 ? 'background: var(--bg-primary);' : 'background: var(--bg-secondary);';
                html += `<tr style="${rowStyle} border-bottom: 1px solid var(--border-color);">`;
                
                // Checkbox
                html += '<td style="padding: 12px 8px; text-align: center;">';
                html += `<input type="checkbox" class="lot-checkbox" data-alert-id="${alert.id}" data-order-id="${alert.shipstation_order_id}" data-item-id="${alert.shipstation_item_id}" data-base-sku="${alert.base_sku}" data-active-lot="${alert.active_lot}" data-order-number="${alert.order_number}" onchange="updateLotSelectionCount()" style="width: 18px; height: 18px; cursor: pointer;">`;
                html += '</td>';
                
                // Order Number
                html += `<td style="padding: 12px 8px;"><strong>${alert.order_number}</strong></td>`;
                
                // SKU
                html += `<td style="padding: 12px 8px; font-family: monospace;">${alert.base_sku}</td>`;
                
                // ShipStation Lot (wrong - red)
                html += `<td style="padding: 12px 8px; color: #f44336; font-weight: 600;">${alert.shipstation_lot || 'NONE'}</td>`;
                
                // Active Lot (correct - green)
                html += `<td style="padding: 12px 8px; color: #4caf50; font-weight: 600;">${alert.active_lot}</td>`;
                
                // Order Status
                html += `<td style="padding: 12px 8px; font-size: 12px;">${alert.order_status}</td>`;
                
                // Detected
                html += `<td style="padding: 12px 8px; font-size: 12px; color: var(--text-tertiary);">${new Date(alert.detected_at).toLocaleDateString()}</td>`;
                
                // Action Button
                html += '<td style="padding: 12px 8px; text-align: center;">';
                html += `<button onclick="updateLotInShipStation(${alert.id}, '${alert.shipstation_order_id}', '${alert.shipstation_item_id}', '${alert.base_sku}', '${alert.active_lot}')" style="padding: 6px 12px; background: var(--accent-orange); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; white-space: nowrap;">üîß Update</button>`;
                html += '</td>';
                
                html += '</tr>';
            });
            
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            
            html += '</div>';
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `<div style="background: var(--bg-primary); border-radius: 12px; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-width: 950px; width: 100%;">${html}<button onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px; padding: 12px 24px; background: var(--primary-navy); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button></div>`;
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        async function resolveLotMismatchAlert(alertId, orderNumber, baseSku) {
            if (!confirm(`Mark lot mismatch for order #${orderNumber} SKU ${baseSku} as resolved?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/lot_mismatch_alerts/${alertId}/resolve`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({resolved_by: 'manual'})
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Lot mismatch alert resolved');
                    await checkLotMismatchAlerts();
                    const modal = document.querySelector('div[style*="z-index: 9999"]');
                    if (modal) modal.remove();
                } else {
                    throw new Error(result.error || 'Failed to resolve alert');
                }
            } catch (error) {
                console.error('Error resolving lot mismatch alert:', error);
                alert('Error resolving alert: ' + error.message);
            }
        }
        
        async function updateLotInShipStation(alertId, orderId, itemId, baseSku, newLot) {
            if (!confirm(`Update lot number to ${newLot} for SKU ${baseSku} in ShipStation order ${orderId}?`)) {
                return;
            }
            
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Updating...';
            
            try {
                const response = await fetch('/api/update_lot_in_shipstation', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        shipstation_order_id: orderId,
                        shipstation_item_id: itemId,
                        base_sku: baseSku,
                        new_lot: newLot,
                        alert_id: alertId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ ${result.message}`);
                    await checkLotMismatchAlerts();
                    const modal = document.querySelector('div[style*="z-index: 9999"]');
                    if (modal) modal.remove();
                } else {
                    throw new Error(result.error || 'Failed to update lot');
                }
            } catch (error) {
                console.error('Error updating lot in ShipStation:', error);
                alert('Error updating lot: ' + error.message);
                btn.disabled = false;
                btn.textContent = `üîß Update Lot to ${newLot} in ShipStation`;
            }
        }
        
        function toggleAllLotCheckboxes() {
            const selectAll = document.getElementById('select-all-lots');
            const checkboxes = document.querySelectorAll('.lot-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateLotSelectionCount();
        }
        
        function updateLotSelectionCount() {
            const checkboxes = document.querySelectorAll('.lot-checkbox:checked');
            const count = checkboxes.length;
            const countSpan = document.getElementById('selected-count');
            const updateBtn = document.getElementById('bulk-update-btn');
            const resolveBtn = document.getElementById('bulk-resolve-btn');
            const selectAll = document.getElementById('select-all-lots');
            
            countSpan.textContent = `${count} selected`;
            
            if (count > 0) {
                updateBtn.disabled = false;
                resolveBtn.disabled = false;
                updateBtn.style.opacity = '1';
                resolveBtn.style.opacity = '1';
                updateBtn.style.cursor = 'pointer';
                resolveBtn.style.cursor = 'pointer';
            } else {
                updateBtn.disabled = true;
                resolveBtn.disabled = true;
                updateBtn.style.opacity = '0.5';
                resolveBtn.style.opacity = '0.5';
                updateBtn.style.cursor = 'not-allowed';
                resolveBtn.style.cursor = 'not-allowed';
            }
            
            // Update select-all checkbox state
            const totalCheckboxes = document.querySelectorAll('.lot-checkbox').length;
            selectAll.checked = count === totalCheckboxes && count > 0;
            selectAll.indeterminate = count > 0 && count < totalCheckboxes;
        }
        
        async function bulkUpdateLots() {
            const checkboxes = document.querySelectorAll('.lot-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('No items selected');
                return;
            }
            
            const count = checkboxes.length;
            if (!confirm(`Update ${count} lot number(s) in ShipStation? This will correct the SKU-Lot format for all selected orders.`)) {
                return;
            }
            
            const updateBtn = document.getElementById('bulk-update-btn');
            updateBtn.disabled = true;
            updateBtn.textContent = `Updating ${count}...`;
            
            // Create progress message element
            const progressDiv = document.createElement('div');
            progressDiv.style.cssText = 'margin-top: 15px; padding: 15px; background: #1e293b; border-radius: 8px; font-family: monospace;';
            progressDiv.innerHTML = `
                <div style="color: #94a3b8; margin-bottom: 8px;">‚è≥ Processing orders (rate-limited to 1 per 1.5 seconds)...</div>
                <div id="progress-status" style="color: #10b981; font-weight: 500;"></div>
                <div style="margin-top: 8px; background: #334155; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div id="progress-bar" style="height: 100%; background: linear-gradient(90deg, #3b82f6, #2563eb); transition: width 0.3s; width: 0%;"></div>
                </div>
            `;
            updateBtn.parentElement.appendChild(progressDiv);
            
            let successCount = 0;
            let failureCount = 0;
            const checkboxArray = Array.from(checkboxes);
            
            for (let i = 0; i < checkboxArray.length; i++) {
                const checkbox = checkboxArray[i];
                const alertId = checkbox.dataset.alertId;
                const orderId = checkbox.dataset.orderId;
                const itemId = checkbox.dataset.itemId;
                const baseSku = checkbox.dataset.baseSku;
                const activeLot = checkbox.dataset.activeLot;
                const orderNumber = checkbox.dataset.orderNumber;
                
                // Update progress indicator
                const progressPercent = Math.round(((i + 1) / count) * 100);
                document.getElementById('progress-status').textContent = 
                    `Order ${i + 1}/${count}: #${orderNumber} (SKU ${baseSku}) - ${successCount} ‚úÖ ${failureCount} ‚ùå`;
                document.getElementById('progress-bar').style.width = `${progressPercent}%`;
                updateBtn.textContent = `Updating ${i + 1}/${count} (${progressPercent}%)`;
                
                try {
                    const response = await fetch('/api/update_lot_in_shipstation', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'include',
                        body: JSON.stringify({
                            shipstation_order_id: orderId,
                            shipstation_item_id: itemId,
                            base_sku: baseSku,
                            new_lot: activeLot,
                            alert_id: alertId
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                    } else {
                        failureCount++;
                        console.error(`Failed to update order ${orderNumber}:`, result.error);
                    }
                } catch (error) {
                    failureCount++;
                    console.error(`Error updating order ${orderNumber}:`, error);
                }
                
                // Add 1.5 second delay between requests to avoid ShipStation rate limiting (40 req/min)
                if (i < checkboxArray.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            // Remove progress indicator
            progressDiv.remove();
            
            alert(`‚úÖ Bulk update complete!\nSuccessful: ${successCount}\nFailed: ${failureCount}`);
            await checkLotMismatchAlerts();
            const modal = document.querySelector('div[style*="z-index: 9999"]');
            if (modal) modal.remove();
        }
        
        async function bulkResolveLots() {
            const checkboxes = document.querySelectorAll('.lot-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('No items selected');
                return;
            }
            
            const count = checkboxes.length;
            if (!confirm(`Mark ${count} lot mismatch alert(s) as resolved?`)) {
                return;
            }
            
            const resolveBtn = document.getElementById('bulk-resolve-btn');
            resolveBtn.disabled = true;
            resolveBtn.textContent = `Resolving ${count}...`;
            
            let successCount = 0;
            let failureCount = 0;
            
            for (const checkbox of checkboxes) {
                const alertId = checkbox.dataset.alertId;
                
                try {
                    const response = await fetch(`/api/lot_mismatch_alerts/${alertId}/resolve`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({resolved_by: 'bulk_manual'})
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                    } else {
                        failureCount++;
                        console.error(`Failed to resolve alert ${alertId}:`, result.error);
                    }
                } catch (error) {
                    failureCount++;
                    console.error(`Error resolving alert ${alertId}:`, error);
                }
                
                resolveBtn.textContent = `Resolved ${successCount}/${count}...`;
            }
            
            alert(`‚úÖ Bulk resolve complete!\nSuccessful: ${successCount}\nFailed: ${failureCount}`);
            await checkLotMismatchAlerts();
            const modal = document.querySelector('div[style*="z-index: 9999"]');
            if (modal) modal.remove();
        }

        // Manual Order Conflicts Functions
        let manualOrderConflictsData = [];
        
        async function checkManualOrderConflicts() {
            try {
                const response = await fetch('/api/manual_order_conflicts');
                const data = await response.json();
                
                if (data.success && data.count > 0) {
                    manualOrderConflictsData = data.conflicts;
                    const conflictAlert = document.getElementById('manual-order-conflict-alert');
                    const conflictCount = document.getElementById('manual-order-conflict-count');
                    conflictCount.textContent = data.count;
                    conflictAlert.style.display = 'block';
                } else {
                    document.getElementById('manual-order-conflict-alert').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking manual order conflicts:', error);
            }
        }
        
        function showManualOrderConflictDetails() {
            if (manualOrderConflictsData.length === 0) {
                alert('No manual order conflicts to display');
                return;
            }
            
            let html = '<div style="max-width: 800px; max-height: 70vh; overflow-y: auto;">';
            html += '<h3 style="margin-top: 0;">Manual Order Conflicts</h3>';
            html += '<p style="color: var(--text-secondary); margin-bottom: 20px;">These manual orders use order numbers that were previously shipped. Recreate them with new order numbers.</p>';
            
            manualOrderConflictsData.forEach((conflict, index) => {
                html += `<div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 16px;">`;
                html += `<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">`;
                html += `<div><strong style="font-size: 16px;">Order #${conflict.conflicting_order_number}</strong>`;
                if (conflict.proposed_new_order_number) {
                    html += ` <span style="color: var(--accent-orange); font-size: 14px;">‚Üí Will become #${conflict.proposed_new_order_number}</span>`;
                }
                html += `<br><span style="color: var(--text-tertiary); font-size: 13px;">Customer: ${conflict.customer_name || 'N/A'}</span></div>`;
                html += `<button onclick="dismissConflict(${conflict.id}, '${conflict.conflicting_order_number}')" style="padding: 6px 12px; background: var(--text-tertiary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">Dismiss</button>`;
                html += `</div>`;
                
                html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 12px; font-size: 13px;">';
                html += '<tbody>';
                html += `<tr style="border-bottom: 1px solid var(--border-color);"><td style="padding: 8px; font-weight: 600;">Original Ship Date</td><td style="padding: 8px;">${conflict.original_ship_date || 'N/A'}</td></tr>`;
                html += `<tr style="border-bottom: 1px solid var(--border-color);"><td style="padding: 8px; font-weight: 600;">ShipStation Order ID</td><td style="padding: 8px; font-family: monospace; font-size: 11px;">${conflict.shipstation_order_id}</td></tr>`;
                html += `<tr><td style="padding: 8px; font-weight: 600;">Detected</td><td style="padding: 8px;">${conflict.detected_at}</td></tr>`;
                html += '</tbody></table>';
                
                // Side-by-side comparison of orders
                html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">';
                
                // Original (Shipped) Order
                html += '<div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; border-left: 3px solid #22c55e;">';
                html += '<strong style="color: #22c55e;">‚úÖ Original (Shipped)</strong>';
                html += `<div style="margin-top: 8px; font-size: 12px;"><strong>Company:</strong> ${conflict.original_company || 'None'}</div>`;
                html += '<div style="margin-top: 8px;"><strong>Items:</strong></div>';
                if (conflict.original_items && conflict.original_items.length > 0) {
                    conflict.original_items.forEach(item => {
                        html += `<div style="font-size: 12px; padding: 4px 0; border-bottom: 1px solid var(--border-color);">`;
                        html += `<span style="font-family: monospace;">${item.sku}</span> √ó ${item.quantity}`;
                        html += `</div>`;
                    });
                } else {
                    html += '<div style="font-size: 12px; color: var(--text-tertiary);">No items</div>';
                }
                html += '</div>';
                
                // Duplicate (Manual) Order
                html += '<div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; border-left: 3px solid #f97316;">';
                html += '<strong style="color: #f97316;">‚ö†Ô∏è Duplicate (Manual)</strong>';
                html += `<div style="margin-top: 8px; font-size: 12px;"><strong>Company:</strong> ${conflict.duplicate_company || 'None'}</div>`;
                html += '<div style="margin-top: 8px;"><strong>Items:</strong></div>';
                if (conflict.duplicate_items && conflict.duplicate_items.length > 0) {
                    conflict.duplicate_items.forEach(item => {
                        html += `<div style="font-size: 12px; padding: 4px 0; border-bottom: 1px solid var(--border-color);">`;
                        html += `<span style="font-family: monospace;">${item.sku}</span> √ó ${item.quantity}`;
                        html += `</div>`;
                    });
                } else {
                    html += '<div style="font-size: 12px; color: var(--text-tertiary);">No items</div>';
                }
                html += '</div>';
                
                html += '</div>';
                
                html += `<button onclick="recreateManualOrder(${conflict.id}, '${conflict.conflicting_order_number}')" style="width: 100%; padding: 10px; background: var(--accent-orange); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üîÑ Recreate with New Order Number</button>`;
                html += '</div>';
            });
            
            html += '</div>';
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'manual-conflict-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `<div style="background: var(--bg-primary); border-radius: 12px; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-width: 900px; width: 100%;">${html}<button onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px; padding: 12px 24px; background: var(--primary-navy); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Close</button></div>`;
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        async function recreateManualOrder(conflictId, oldOrderNumber) {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Creating new order...';
            
            try {
                const response = await fetch(`/api/manual_order_conflicts/${conflictId}/recreate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Close the details modal
                    const modal = document.getElementById('manual-conflict-modal');
                    if (modal) modal.remove();
                    
                    // Show confirmation dialog
                    showConfirmationDialog(conflictId, oldOrderNumber, result.new_order_number);
                } else {
                    throw new Error(result.error || 'Failed to recreate order');
                }
            } catch (error) {
                console.error('Error recreating order:', error);
                alert('Error recreating order: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'üîÑ Recreate with New Order Number';
            }
        }
        
        function showConfirmationDialog(conflictId, oldOrderNumber, newOrderNumber) {
            let html = '<div style="max-width: 600px;">';
            html += '<h3 style="margin-top: 0; color: #22c55e;">‚úÖ New Order Created Successfully</h3>';
            html += '<div style="background: var(--bg-secondary); border-radius: 8px; padding: 20px; margin: 20px 0;">';
            html += `<p style="font-size: 16px; margin-bottom: 12px;">Old Order: <strong style="text-decoration: line-through; color: var(--text-tertiary);">${oldOrderNumber}</strong></p>`;
            html += `<p style="font-size: 18px; margin-bottom: 12px;">New Order: <strong style="color: var(--accent-orange); font-size: 22px;">${newOrderNumber}</strong></p>`;
            html += '</div>';
            html += '<p style="color: var(--text-secondary); margin: 20px 0;">Please verify the new order was created properly in ShipStation before proceeding.</p>';
            html += '<div style="display: flex; gap: 12px; margin-top: 24px;">';
            html += `<button onclick="confirmDeleteOldOrder(${conflictId}, '${oldOrderNumber}', '${newOrderNumber}')" style="flex: 1; padding: 12px; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Confirm & Delete Old Order</button>`;
            html += `<button onclick="this.closest('[id=confirmation-modal]').remove(); checkManualOrderConflicts();" style="flex: 1; padding: 12px; background: var(--text-tertiary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Cancel</button>`;
            html += '</div>';
            html += '</div>';
            
            const modal = document.createElement('div');
            modal.id = 'confirmation-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `<div style="background: var(--bg-primary); border-radius: 12px; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">${html}</div>`;
            document.body.appendChild(modal);
        }
        
        async function confirmDeleteOldOrder(conflictId, oldOrderNumber, newOrderNumber) {
            const modal = document.getElementById('confirmation-modal');
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Deleting old order...';
            
            try {
                const response = await fetch(`/api/manual_order_conflicts/${conflictId}/confirm_delete`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ ${result.message}`);
                    modal.remove();
                    await checkManualOrderConflicts();
                } else {
                    throw new Error(result.error || 'Failed to delete old order');
                }
            } catch (error) {
                console.error('Error deleting old order:', error);
                alert('Error deleting old order: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Confirm & Delete Old Order';
            }
        }
        
        async function dismissConflict(conflictId, orderNumber) {
            if (!confirm(`Dismiss conflict for order #${orderNumber}? This will not recreate the order.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/manual_order_conflicts/${conflictId}/dismiss`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Conflict dismissed');
                    await checkManualOrderConflicts();
                    const modal = document.getElementById('manual-conflict-modal');
                    if (modal) modal.remove();
                } else {
                    throw new Error(result.error || 'Failed to dismiss conflict');
                }
            } catch (error) {
                console.error('Error dismissing conflict:', error);
                alert('Error dismissing conflict: ' + error.message);
            }
        }

        // FedEx Pickup Completion Handler
        async function markFedExPickupComplete() {
            if (!confirm('Mark FedEx pickup as completed? This will log the completion timestamp.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/fedex_pickup/mark_completed', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ FedEx pickup marked as completed');
                    // Refresh dashboard to show completion status
                    await loadDashboardData();
                } else {
                    throw new Error(result.error || 'Failed to mark pickup as complete');
                }
            } catch (error) {
                console.error('Error marking FedEx pickup complete:', error);
                alert('Error: ' + error.message);
            }
        }

        // EOD Button Handler
        async function runEOD() {
            const btn = document.getElementById('btn-eod');
            const statusDiv = document.getElementById('eod-status');
            const originalStatus = statusDiv.textContent;
            
            btn.disabled = true;
            statusDiv.textContent = 'Running...';
            btn.style.opacity = '0.6';
            
            try {
                const response = await fetch('/api/reports/eod', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    // Refresh weekly inventory report on dashboard
                    await loadWeeklyReport();
                    
                    alert('‚úÖ ' + result.message);
                    await loadReportStatus();
                } else {
                    throw new Error(result.error || 'Failed to run EOD');
                }
            } catch (error) {
                console.error('Error running EOD:', error);
                alert('Error running EOD: ' + error.message);
                statusDiv.textContent = originalStatus;
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        // EOW Button Handler
        async function runEOW() {
            const btn = document.getElementById('btn-eow');
            const statusDiv = document.getElementById('eow-status');
            const originalStatus = statusDiv.textContent;
            
            btn.disabled = true;
            statusDiv.textContent = 'Running...';
            btn.style.opacity = '0.6';
            
            try {
                const response = await fetch('/api/reports/eow', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    // Refresh weekly inventory report on dashboard
                    await loadWeeklyReport();
                    
                    alert('‚úÖ ' + result.message);
                    await loadReportStatus();
                } else {
                    throw new Error(result.error || 'Failed to run EOW');
                }
            } catch (error) {
                console.error('Error running EOW:', error);
                alert('Error running EOW: ' + error.message);
                statusDiv.textContent = originalStatus;
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        // EOM Button Handler
        async function runEOM() {
            const btn = document.getElementById('btn-eom');
            const statusDiv = document.getElementById('eom-status');
            const originalStatus = statusDiv.textContent;
            
            btn.disabled = true;
            statusDiv.textContent = 'Running...';
            btn.style.opacity = '0.6';
            
            try {
                const response = await fetch('/api/reports/eom', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ ' + result.message);
                    await loadReportStatus();
                } else {
                    throw new Error(result.error || 'Failed to run EOM');
                }
            } catch (error) {
                console.error('Error running EOM:', error);
                alert('Error running EOM: ' + error.message);
                statusDiv.textContent = originalStatus;
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        // Load button status indicators
        async function loadReportStatus() {
            try {
                const response = await fetch('/api/reports/status');
                const result = await response.json();
                
                if (result.success) {
                    const formatTime = (dateStr) => {
                        if (!dateStr) return '';
                        const date = new Date(dateStr);
                        return date.toLocaleString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    };
                    
                    if (result.data.EOD) {
                        document.getElementById('eod-status').textContent = formatTime(result.data.EOD.run_date);
                    }
                    if (result.data.EOW) {
                        document.getElementById('eow-status').textContent = formatTime(result.data.EOW.run_date);
                    }
                    if (result.data.EOM) {
                        document.getElementById('eom-status').textContent = formatTime(result.data.EOM.run_date);
                    }
                }
            } catch (error) {
                console.error('Error loading report status:', error);
            }
        }

        // Populate User Widget
        async function populateUserWidget() {
            const widget = document.getElementById('user-widget');
            const authStatus = await window.auth.getAuthStatus();
            
            if (authStatus.authenticated && authStatus.user) {
                const user = authStatus.user;
                
                // Show widget
                widget.style.display = 'flex';
                
                // Set user name
                const userName = user.first_name && user.last_name 
                    ? `${user.first_name} ${user.last_name}`
                    : user.email || 'User';
                document.getElementById('user-name').textContent = userName;
                
                // Set avatar
                const avatarImg = document.getElementById('user-avatar-img');
                const avatarInitials = document.getElementById('user-avatar-initials');
                
                if (user.profile_image_url) {
                    avatarImg.src = user.profile_image_url;
                    avatarImg.style.display = 'block';
                    avatarInitials.style.display = 'none';
                } else {
                    // Generate initials
                    let initials = 'U';
                    if (user.first_name && user.last_name) {
                        initials = user.first_name[0] + user.last_name[0];
                    } else if (user.email) {
                        initials = user.email[0].toUpperCase();
                    }
                    avatarInitials.textContent = initials.toUpperCase();
                    avatarInitials.style.display = 'flex';
                    avatarImg.style.display = 'none';
                }
                
                // Set role badge
                const roleBadge = document.getElementById('user-role-badge');
                const roleText = document.getElementById('user-role-text');
                const role = user.role || 'viewer';
                
                roleText.textContent = role.charAt(0).toUpperCase() + role.slice(1);
                roleBadge.className = `user-role-badge ${role}`;
            } else {
                widget.style.display = 'none';
            }
        }

        // Logout function
        function logout() {
            window.auth.logout();
        }

        // Physical Count Adjustment Modal
        function openPhysicalCountModal(sku, systemQuantity, productName) {
            const modal = document.getElementById('physical-count-modal');
            document.getElementById('modal-sku').textContent = sku;
            document.getElementById('modal-product-name').textContent = productName || '';
            document.getElementById('modal-system-qty').value = systemQuantity;
            document.getElementById('modal-physical-count').value = '';
            document.getElementById('modal-difference').textContent = '0';
            document.getElementById('modal-difference').className = 'difference-neutral';
            document.getElementById('modal-reason').value = '';
            document.getElementById('submit-adjustment-btn').disabled = false;
            
            // Store data for submission
            modal.dataset.sku = sku;
            modal.dataset.systemQuantity = systemQuantity;
            
            modal.style.display = 'flex';
        }

        function closePhysicalCountModal() {
            document.getElementById('physical-count-modal').style.display = 'none';
        }

        function calculateDifference() {
            const systemQty = parseInt(document.getElementById('physical-count-modal').dataset.systemQuantity);
            const physicalCount = parseInt(document.getElementById('modal-physical-count').value);
            const diffElement = document.getElementById('modal-difference');
            
            if (isNaN(physicalCount)) {
                diffElement.textContent = '0';
                diffElement.className = 'difference-neutral';
                return;
            }
            
            const difference = physicalCount - systemQty;
            diffElement.textContent = difference > 0 ? `+${difference}` : difference;
            
            if (difference > 0) {
                diffElement.className = 'difference-positive';
            } else if (difference < 0) {
                diffElement.className = 'difference-negative';
            } else {
                diffElement.className = 'difference-neutral';
            }
        }

        async function submitPhysicalCountAdjustment() {
            const modal = document.getElementById('physical-count-modal');
            const sku = modal.dataset.sku;
            const systemQty = parseInt(modal.dataset.systemQuantity);
            const physicalCount = parseInt(document.getElementById('modal-physical-count').value);
            const reason = document.getElementById('modal-reason').value.trim();
            const submitBtn = document.getElementById('submit-adjustment-btn');
            
            if (isNaN(physicalCount) || physicalCount < 0) {
                alert('Please enter a valid physical count (0 or greater)');
                return;
            }
            
            if (!reason) {
                alert('Please provide a reason for the adjustment');
                document.getElementById('modal-reason').focus();
                return;
            }
            
            const difference = physicalCount - systemQty;
            
            if (difference === 0) {
                alert('Physical count matches system quantity - no adjustment needed');
                return;
            }
            
            // Confirm large adjustments
            if (Math.abs(difference) > 4) {
                const confirmMsg = `This is a large adjustment (${difference > 0 ? '+' : ''}${difference} units).\n\n` +
                                  `Note: Adjustments > 4 units require admin approval.\n\n` +
                                  `Continue?`;
                if (!confirm(confirmMsg)) {
                    return;
                }
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            try {
                const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                const response = await fetch('/api/physical_count_adjustment', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        sku,
                        physical_count: physicalCount,
                        reason,
                        user_timezone: userTimezone
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    if (result.requires_admin) {
                        alert(`‚ùå ${result.error}\n\nYou are logged in as a viewer. Please ask an admin to approve this adjustment of ${result.difference > 0 ? '+' : ''}${result.difference} units.`);
                    } else {
                        throw new Error(result.error || 'Failed to submit adjustment');
                    }
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Adjustment';
                    return;
                }
                
                alert(`‚úÖ ${result.message}\n\nAdjusted by: ${result.adjusted_by}\nTime: ${result.timestamp}`);
                closePhysicalCountModal();
                await loadWeeklyReport();
                
            } catch (error) {
                console.error('Error submitting adjustment:', error);
                alert('Error submitting adjustment: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Adjustment';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAutoShipDay();
            loadDashboardData();
            loadWeeklyReport();
            loadReportStatus();
            populateUserWidget();
        });
    </script>
    
    <!-- Physical Count Adjustment Modal -->
    <div id="physical-count-modal" class="modal-overlay" style="display: none;" onclick="if(event.target === this) closePhysicalCountModal()">
        <div class="modal-dialog" style="max-width: 500px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>üì¶ Physical Count Adjustment</h3>
                <button class="modal-close" onclick="closePhysicalCountModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 5px;">SKU</div>
                            <div style="font-weight: 600;" id="modal-sku"></div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--text-tertiary); margin-bottom: 5px;">Product</div>
                            <div style="font-weight: 600;" id="modal-product-name"></div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>System Quantity</label>
                    <input type="text" id="modal-system-qty" readonly style="background: var(--bg-tertiary); color: var(--text-tertiary); cursor: not-allowed;">
                </div>
                
                <div class="form-group">
                    <label>Physical Count <span style="color: var(--critical-red);">*</span></label>
                    <input type="number" id="modal-physical-count" min="0" placeholder="Enter actual count from physical inventory" oninput="calculateDifference()" autofocus>
                </div>
                
                <div class="form-group">
                    <label>Difference</label>
                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; text-align: center; font-size: 1.5rem; font-weight: 700;">
                        <span id="modal-difference" class="difference-neutral">0</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Reason <span style="color: var(--critical-red);">*</span></label>
                    <textarea id="modal-reason" rows="3" placeholder="e.g., Physical count discrepancy, Damaged units found, etc." required></textarea>
                </div>
                
                <div style="font-size: 0.813rem; color: var(--text-tertiary); padding: 10px; background: var(--bg-secondary); border-radius: 6px; margin-top: 15px;">
                    ‚ÑπÔ∏è <strong>Note:</strong> Adjustments greater than 4 units require admin approval. Your name, timezone, and timestamp will be recorded.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePhysicalCountModal()">Cancel</button>
                <button class="btn btn-primary" id="submit-adjustment-btn" onclick="submitPhysicalCountAdjustment()">Submit Adjustment</button>
            </div>
        </div>
    </div>
    
    <!-- Interactive Training Tours -->
    <script src="/static/tour.js"></script>
</body>
</html>
