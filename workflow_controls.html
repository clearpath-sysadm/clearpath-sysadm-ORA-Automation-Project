<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Controls - Oracare Fulfillment</title>
    
    <!-- Premium Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Source+Serif+4:wght@600&display=swap" rel="stylesheet">
    
    <!-- Global Premium Design System -->
    <link rel="stylesheet" href="/static/css/global-styles.css">
</head>
<body>
    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileMenu()"></div>

    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo"><img src="/static/images/oracare-logo.png" alt="Oracare" style="width: 100%; height: 100%; object-fit: contain;"></div>
                <div class="sidebar-title">Oracare Fulfillment</div>
            </div>
            
            <nav class="sidebar-nav">
                <!-- Primary Navigation -->
                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <a href="/" class="nav-item">
                        <span class="nav-item-icon">üìä</span>
                        Dashboard
                    </a>
                    <a href="/xml_import.html" class="nav-item">
                        <span class="nav-item-icon">üì•</span>
                        Orders Inbox
                    </a>
                    <a href="/inventory_transactions.html" class="nav-item">
                        <span class="nav-item-icon">üì¶</span>
                        Inventory Monitor
                    </a>
                    <a href="/lot_inventory.html" class="nav-item">
                        <span class="nav-item-icon">üè≠</span>
                        Lot Inventory
                    </a>
                    <a href="/charge_report.html" class="nav-item">
                        <span class="nav-item-icon">üí∞</span>
                        Charge Report
                    </a>
                </div>

                <!-- Admin Section -->
                <div class="nav-section admin-section">
                    <div class="admin-toggle" onclick="toggleAdmin()">
                        <span>Admin & Data</span>
                        <span class="admin-toggle-icon">‚ñ∂</span>
                    </div>
                    <div class="admin-items" id="admin-items">
                        <a href="/weekly_shipped_history.html" class="nav-item">
                            <span class="nav-item-icon">üìà</span>
                            Weekly Reports
                        </a>
                        <a href="/shipped_orders.html" class="nav-item">
                            <span class="nav-item-icon">üìã</span>
                            Shipped Orders
                        </a>
                        <a href="/order_audit.html" class="nav-item">
                            <span class="nav-item-icon">üîç</span>
                            Order Audit
                        </a>
                        <a href="/shipped_items.html" class="nav-item">
                            <span class="nav-item-icon">üìä</span>
                            Shipped Items
                        </a>
                        <a href="/bundle_skus.html" class="nav-item">
                            <span class="nav-item-icon">üì¶</span>
                            Bundle SKUs
                        </a>
                        <a href="/sku_lot.html" class="nav-item">
                            <span class="nav-item-icon">üè∑Ô∏è</span>
                            SKU Lot Management
                        </a>
                        <a href="/workflow_controls.html" class="nav-item active">
                            <span class="nav-item-icon">‚öôÔ∏è</span>
                            Workflow Controls
                        </a>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="nav-section" style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: calc(var(--spacing-unit) * 2);">
                    <a href="/help.html" class="nav-item">
                        <span class="nav-item-icon">üìö</span>
                        Help & Training
                    </a>
                    <a href="/settings.html" class="nav-item">
                        <span class="nav-item-icon">‚öôÔ∏è</span>
                        Settings
                    </a>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <h1 class="page-title">Workflow Controls</h1>
                </div>
                <div class="top-bar-actions">
                    <button class="dark-mode-toggle" onclick="toggleDarkMode()">üåô</button>
                </div>
            </div>

            <div class="content-area">
                <div class="warning-banner">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <div class="warning-content">
                        <div class="warning-title">Important</div>
                        <div class="warning-text">Disabling workflows will pause automation. Use this to prevent dev/prod conflicts or during maintenance. Changes take effect within 60 seconds.</div>
                    </div>
                </div>

                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Workflow</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Last Sync</th>
                                <th style="width: 100px;">Toggle</th>
                            </tr>
                        </thead>
                        <tbody id="workflows-table">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                                    Loading workflows...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="/static/dark-mode.js"></script>
    <script src="/static/js/auth.js"></script>


    <script>
        const WORKFLOW_INFO = {
            'xml-import': {
                name: 'XML Import',
                description: 'Imports orders from Google Drive XML files every 5 minutes'
            },
            'shipstation-upload': {
                name: 'ShipStation Upload',
                description: 'Uploads pending orders to ShipStation every 5 minutes'
            },
            'unified-shipstation-sync': {
                name: 'Unified ShipStation Sync',
                description: 'Syncs manual orders and status updates from ShipStation every 5 minutes (replaces manual-order-sync and status-sync)'
            },
            'orders-cleanup': {
                name: 'Orders Cleanup',
                description: 'Deletes old orders (60+ days) daily'
            },
            'weekly-reporter': {
                name: 'Weekly Reporter',
                description: 'Generates weekly inventory report (runs at startup)'
            }
        };

        async function loadWorkflows() {
            try {
                const response = await fetch('/api/workflow_controls');
                const workflows = await response.json();
                
                const tbody = document.getElementById('workflows-table');
                tbody.innerHTML = '';
                
                workflows.forEach(workflow => {
                    const info = WORKFLOW_INFO[workflow.name] || { 
                        name: workflow.name, 
                        description: 'Automation workflow' 
                    };
                    const row = createWorkflowRow(workflow, info);
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Failed to load workflows:', error);
                const tbody = document.getElementById('workflows-table');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-danger);">
                            Error loading workflows
                        </td>
                    </tr>
                `;
            }
        }

        function formatRelativeTime(timestamp) {
            if (!timestamp) return 'Never';
            
            const now = new Date();
            const then = new Date(timestamp);
            const seconds = Math.floor((now - then) / 1000);
            const minutes = Math.floor(seconds / 60);
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes} min ago`;
            if (minutes < 1440) return `${Math.floor(minutes / 60)} hr ago`;
            return `${Math.floor(minutes / 1440)} days ago`;
        }

        function createWorkflowRow(workflow, info) {
            const tr = document.createElement('tr');
            tr.style.cursor = 'pointer';
            
            const lastRunText = formatRelativeTime(workflow.last_run_at);
            const statusClass = workflow.enabled ? 'enabled' : 'disabled';
            const statusText = workflow.enabled ? 'Enabled' : 'Disabled';
            
            tr.innerHTML = `
                <td><strong>${info.name}</strong></td>
                <td>${info.description}</td>
                <td>
                    <span class="status-indicator ${statusClass}"></span>
                    <span>${statusText}</span>
                </td>
                <td>${lastRunText}</td>
                <td onclick="event.stopPropagation()">
                    <label class="toggle-switch">
                        <input type="checkbox" ${workflow.enabled ? 'checked' : ''} 
                               onchange="toggleWorkflow('${workflow.name}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </td>
            `;
            
            // Make row clickable (except the toggle column)
            tr.addEventListener('click', function(e) {
                if (e.target.closest('td:last-child')) return; // Don't trigger on toggle column
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                toggleWorkflow(workflow.name, checkbox.checked);
            });
            
            return tr;
        }

        async function toggleWorkflow(name, enabled) {
            try {
                const response = await fetch(`/api/workflow_controls/${name}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log(`Workflow ${name} ${enabled ? 'enabled' : 'disabled'}`);
                    await loadWorkflows();
                } else {
                    console.error('Failed to toggle workflow:', result.error);
                    alert('Failed to toggle workflow: ' + result.error);
                    await loadWorkflows();
                }
            } catch (error) {
                console.error('Error toggling workflow:', error);
                alert('Error toggling workflow');
                await loadWorkflows();
            }
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        // Admin section toggle
        function toggleAdmin() {
            const adminItems = document.getElementById('admin-items');
            const adminToggle = document.querySelector('.admin-toggle-icon');
            adminItems.classList.toggle('open');
            adminToggle.classList.toggle('open');
        }

        // Dark mode toggle
        // Initialize dark mode from localStorage
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
            document.querySelector('.dark-mode-toggle').textContent = '‚òÄÔ∏è';
        }

        // Keep admin section open if on admin page
        if (window.location.pathname.includes('workflow_controls')) {
            const adminItems = document.getElementById('admin-items');
            const adminToggle = document.querySelector('.admin-toggle-icon');
            adminItems.classList.add('open');
            adminToggle.classList.add('open');
        }

        loadWorkflows();
        setInterval(loadWorkflows, 5000);
    </script>
    <script src="/static/js/auth.js"></script>
    <!-- Interactive Training Tours -->
    <script src="/static/tour.js"></script>
    <script src="/static/js/auth.js"></script>
</body>
</html>
