import sys
import os

# Add the project root to the Python path to enable imports from utils and services
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
if project_root not in sys.path:
    sys.path.insert(0, project_root)

# Standard library imports needed for basic script operation (sys.exit, os.path.exists)
# All other library imports (requests, base64, json, datetime, time, xml.etree.ElementTree, pandas)
# are now encapsulated within their respective service modules.

# Core utility imports
from utils.logging_config import setup_logging
import logging

# Import from centralized configuration settings
from config import settings

# Import necessary service modules
from src.services.gcp.secret_manager import access_secret_version
from src.services.shipstation.api_client import send_all_orders_to_shipstation
from src.services.data_parsers.x_cart_parser import parse_x_cart_xml_for_shipstation_payload # Only this is needed for main flow


# --- Setup Logging for this script ---
_log_dir = os.path.join(os.path.dirname(__file__), '..', 'logs')
_log_file = os.path.join(_log_dir, 'app.log')
# Ensure logging is only configured once if this script is run as main.
if not logging.getLogger().handlers:
    setup_logging(log_file_path=_log_file, log_level=logging.INFO, enable_console_logging=True)
logger = logging.getLogger(__name__)


# --- Main execution block ---
if __name__ == "__main__":
    logger.info("Starting ShipStation Order Uploader Script (main orchestrator)...")

    # --- Retrieve API credentials ---
    shipstation_api_key = access_secret_version(
        settings.YOUR_GCP_PROJECT_ID,
        settings.SHIPSTATION_API_KEY_SECRET_ID,
        credentials_path=settings.SERVICE_ACCOUNT_KEY_PATH
    )
    shipstation_api_secret = access_secret_version(
        settings.YOUR_GCP_PROJECT_ID,
        settings.SHIPSTATION_API_SECRET_SECRET_ID,
        credentials_path=settings.SERVICE_ACCOUNT_KEY_PATH
    )

    if not shipstation_api_key or not shipstation_api_secret:
        logger.critical("Failed to retrieve ShipStation API credentials. Exiting.")
        sys.exit(1) # Use sys.exit(1) for abnormal termination

    logger.info(f"ShipStation API Key retrieved (truncated): {shipstation_api_key[:5]}...")
    logger.info(f"ShipStation API Secret retrieved (truncated): {shipstation_api_secret[:5]}...")

    # --- Parse Data from X-Cart XML ---
    logger.info(f"Loading orders from X-Cart XML file: {settings.X_CART_XML_PATH}...")
    # Using the modularized parser
    all_orders_payload = parse_x_cart_xml_for_shipstation_payload(
        settings.X_CART_XML_PATH, 
        settings.BUNDLE_CONFIG
    )
        
    if not all_orders_payload:
        logger.warning("No valid orders to send to ShipStation after processing XML. Exiting.")
        sys.exit(0) # Use sys.exit(0) for graceful exit with no orders

    logger.info(f"Prepared {len(all_orders_payload)} orders for upload to ShipStation.")

    # --- Send Orders to ShipStation ---
    # Using the modularized API client
    upload_results = send_all_orders_to_shipstation(
        all_orders_payload,
        shipstation_api_key,
        shipstation_api_secret,
        settings.SHIPSTATION_CREATE_ORDERS_ENDPOINT
    )

    if upload_results:
        logger.info(f"--- ShipStation Upload Results ---")
        for result in upload_results:
            logger.info(f"OrderKey: {result.get('orderKey')}, Success: {result.get('success')}, ErrorMessage: {result.get('errorMessage')}")
    else:
        logger.warning("No results returned from ShipStation upload or an error occurred during sending.")

    logger.info("Script finished. (Order upload attempt completed)")
