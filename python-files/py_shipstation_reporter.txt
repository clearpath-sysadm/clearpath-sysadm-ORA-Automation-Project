import sys
import os

# Add the project root to the Python path to enable imports from utils and services
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
if project_root not in sys.path:
    sys.path.insert(0, project_root)

# Standard library imports needed for basic script operation (sys.exit, os.path.exists)
import datetime # Still needed for date comparison in some validator functions or main logic
import pandas as pd # Re-added: Needed for pd.DataFrame in unit tests

# Core utility imports
from utils.logging_config import setup_logging
import logging

# Import from centralized configuration settings
from config import settings

# Import necessary service modules (only those directly called by the orchestrator)
from src.services.gcp.secret_manager import access_secret_version
from src.services.google_sheets.sheets_api import get_google_sheet_data # Needed for validation step
from src.services.reporting_logic.report_data_loader import get_key_skus_and_product_names, load_all_configuration_data, get_weekly_shipped_history
from src.services.reporting_logic.monthly_report_generator import generate_monthly_charge_report
from src.services.reporting_logic.weekly_report_generator import generate_weekly_inventory_report

# Import the data_validator module (still directly used by orchestrator for pre-validation)
import debug.data_validator as data_validator

# Import specific calculation functions for unit tests
from src.services.reporting_logic.inventory_calculations import calculate_current_inventory
from src.services.reporting_logic.average_calculations import calculate_12_month_rolling_average


# --- Setup Logging for this script ---
_log_dir = os.path.join(os.path.dirname(__file__), '..', 'logs')
_log_file = os.path.join(_log_dir, 'app.log')
if not logging.getLogger().handlers:
    setup_logging(log_file_path=_log_file, log_level=logging.INFO, enable_console_logging=True)
logger = logging.getLogger(__name__)


# --- Main execution block ---
if __name__ == "__main__":
    logger.info("Starting ShipStation Reporter Script (main orchestrator)...")

    # --- Retrieve API credentials ---
    shipstation_api_key = access_secret_version(
        settings.YOUR_GCP_PROJECT_ID,
        settings.SHIPSTATION_API_KEY_SECRET_ID,
        credentials_path=settings.SERVICE_ACCOUNT_KEY_PATH
    )
    shipstation_api_secret = access_secret_version(
        settings.YOUR_GCP_PROJECT_ID,
        settings.SHIPSTATION_API_SECRET_SECRET_ID,
        credentials_path=settings.SERVICE_ACCOUNT_KEY_PATH
    )

    if not shipstation_api_key or not shipstation_api_secret:
        logger.critical("Failed to retrieve ShipStation API credentials. Aborting script.")
        sys.exit(1)

    logger.info(f"ShipStation API Key retrieved (truncated): {shipstation_api_key[:5]}...")
    logger.info(f"ShipStation API Secret retrieved (truncated): {shipstation_api_secret[:5]}...")
    
    # Verify service account key file path exists for Google Sheets API calls
    if not os.path.exists(settings.SERVICE_ACCOUNT_KEY_PATH):
        logger.critical(f"Service account key path '{settings.SERVICE_ACCOUNT_KEY_PATH}' does not exist. Aborting script.")
        sys.exit(1)


    # --- Pre-validation of all Google Sheets data using data_validator ---
    logger.info("Running Data Validation Before Processing ---")
    
    # Load Key SKUs and product names for validation and later use
    key_skus_for_report, product_names_map = get_key_skus_and_product_names(
        settings.GOOGLE_SHEET_ID, 
        settings.ORA_CONFIGURATION_TAB_NAME, 
        settings.SERVICE_ACCOUNT_KEY_PATH
    )
    config_raw_data = get_google_sheet_data(settings.GOOGLE_SHEET_ID, f'{settings.ORA_CONFIGURATION_TAB_NAME}!A:F', settings.SERVICE_ACCOUNT_KEY_PATH)
    config_success, config_msg = data_validator.validate_ora_configuration(config_raw_data)
    logger.info(f"ORA Configuration Validation: {config_msg}")
    if not config_success:
        logger.critical("ORA Configuration validation failed. Aborting script execution.")
        sys.exit(1) 

    if not key_skus_for_report:
        logger.critical("No Key SKUs extracted from ORA_Configuration. Aborting script.")
        sys.exit(1)
    
    # Load raw data for validation
    weekly_history_raw_data = get_google_sheet_data(settings.GOOGLE_SHEET_ID, f'{settings.ORA_WEEKLY_SHIPPED_HISTORY_TAB_NAME}!A:E', settings.SERVICE_ACCOUNT_KEY_PATH)
    weekly_history_success, weekly_history_msg = data_validator.validate_weekly_shipped_history(weekly_history_raw_data, key_skus_for_report)
    logger.info(f"Weekly Shipped History Validation: {weekly_history_msg}")
    if not weekly_history_success:
        logger.critical("Weekly Shipped History validation failed. Aborting script execution.")
        sys.exit(1)

    golden_raw_raw_data = get_google_sheet_data(settings.GOOGLE_SHEET_ID, f'{settings.GOLDEN_TEST_DATA_RAW_TAB_NAME}!A:H', settings.SERVICE_ACCOUNT_KEY_PATH)
    golden_raw_success, golden_raw_msg = data_validator.validate_golden_test_data_raw(golden_raw_raw_data)
    logger.info(f"Golden Test Data Raw Validation: {golden_raw_msg}")
    if not golden_raw_success:
        logger.critical("Golden Test Data Raw validation failed. Aborting script execution.")
        sys.exit(1)

    inventory_trans_raw_data = get_google_sheet_data(settings.GOOGLE_SHEET_ID, f'{settings.INVENTORY_TRANSACTIONS_TAB_NAME}!A:D', settings.SERVICE_ACCOUNT_KEY_PATH)
    inventory_trans_success, inventory_trans_msg = data_validator.validate_inventory_transactions(inventory_trans_raw_data)
    logger.info(f"Inventory Transactions Validation: {inventory_trans_msg}")
    if not inventory_trans_success:
        logger.critical("Inventory Transactions validation failed. Aborting script execution.")
        sys.exit(1)

    logger.info("All Data Sources Validated Successfully. Proceeding with Report Generation.")


    # --- Load Configuration and Transactional Data for processing ---
    RATES, PALLET_COUNTS, INITIAL_INVENTORY, INVENTORY_TRANSACTIONS_DF = load_all_configuration_data(
        settings.GOOGLE_SHEET_ID, 
        settings.ORA_CONFIGURATION_TAB_NAME, 
        settings.INVENTORY_TRANSACTIONS_TAB_NAME, 
        settings.SERVICE_ACCOUNT_KEY_PATH, 
        key_skus_for_report # This is the list of key SKUs
    )
    
    logger.info(f"Rates: {RATES}")
    logger.info(f"Pallet Counts: {PALLET_COUNTS}")
    logger.info(f"Initial Inventory (EOD_Prior_Week): {INITIAL_INVENTORY}")
    logger.info(f"Key SKUs for Weekly Report (extracted from config): {key_skus_for_report}") 
    
    # Get weekly_shipped_history_df data using report_data_loader
    weekly_shipped_history_df = get_weekly_shipped_history(
        settings.GOOGLE_SHEET_ID, 
        settings.ORA_WEEKLY_SHIPPED_HISTORY_TAB_NAME, 
        settings.SERVICE_ACCOUNT_KEY_PATH, 
        key_skus_for_report
    )
    logger.info(f"Weekly Shipped History Data (from Google Sheet). Shape: {weekly_shipped_history_df.shape}")
    logger.debug(f"Head:\n{weekly_shipped_history_df.head()}")
    logger.debug(f"Tail:\n{weekly_shipped_history_df.tail()}")

    # --- Generate Monthly Charge Report ---
    daily_inventory_df, daily_shipped_sku_qty_df = generate_monthly_charge_report(
        shipstation_api_key=shipstation_api_key, 
        shipstation_api_secret=shipstation_api_secret, 
        google_sheet_id=settings.GOOGLE_SHEET_ID, 
        monthly_charge_report_tab_name=settings.MONTHLY_CHARGE_REPORT_TAB_NAME, 
        service_account_credentials_path=settings.SERVICE_ACCOUNT_KEY_PATH, 
        initial_inventory_map=INITIAL_INVENTORY, 
        pallet_counts=PALLET_COUNTS, 
        rates=RATES, 
        raw_golden_test_data_raw=golden_raw_raw_data, 
        inventory_transactions_raw=inventory_trans_raw_data, 
        bundle_config=settings.BUNDLE_CONFIG
    )

    logger.info("Confirmation of Monthly Report Outputs for Weekly Report Input:")
    logger.info(f"DailyInventory_DF is now available for further processing. Shape: {daily_inventory_df.shape}")
    logger.debug(f"Head:\n{daily_inventory_df.head()}")
    logger.info(f"DailyShippedSKUQty_DF is also available. Shape: {daily_shipped_sku_qty_df.shape}")
    logger.debug(f"Head:\n{daily_shipped_sku_qty_df.head()}")

    # --- Generate and Write Weekly Inventory Report ---
    weekly_inventory_report_df = generate_weekly_inventory_report(
        google_sheet_id=settings.GOOGLE_SHEET_ID, 
        weekly_report_tab_name=settings.WEEKLY_REPORT_TAB_NAME, 
        service_account_file_path=settings.SERVICE_ACCOUNT_KEY_PATH, 
        daily_inventory_df=daily_inventory_df, 
        weekly_shipped_history_df=weekly_shipped_history_df, 
        key_skus_for_report=key_skus_for_report,
        product_names_map=product_names_map 
    )
    logger.info(f"Final Weekly Inventory Report. Shape: {weekly_inventory_report_df.shape}")
    logger.debug(f"Head:\n{weekly_inventory_report_df.head()}")

    # The write_google_sheet_data function is called internally within generate_weekly_inventory_report,
    # so no explicit call is needed here. We just log confirmation of the overall process.
    logger.info("Weekly Inventory Report writing process complete.") 

    # --- Consolidated Unit Tests ---
    logger.info("Running Consolidated Unit Tests...")

    # Unit Test for calculate_current_inventory
    if not daily_inventory_df.empty:
        # Expected values updated based on actual output from earlier independent module tests
        expected_current_inventory_df_live_test = pd.DataFrame({
            'SKU': ['17612', '17904', '17914', '18675'],
            'Current Quantity': [634, 198, 361, 774] 
        })
        actual_current_inventory_df_test = calculate_current_inventory(daily_inventory_df.copy(), key_skus_for_report)
        
        actual_current_inventory_df_test = actual_current_inventory_df_test.sort_values(by='SKU').reset_index(drop=True)
        expected_current_inventory_df_live_test = expected_current_inventory_df_live_test.sort_values(by='SKU').reset_index(drop=True)

        actual_current_inventory_df_test['Current Quantity'] = actual_current_inventory_df_test['Current Quantity'].astype(int) 
        expected_current_inventory_df_live_test['Current Quantity'] = expected_current_inventory_df_live_test['Current Quantity'].astype(int) 

        if actual_current_inventory_df_test.equals(expected_current_inventory_df_live_test):
            logger.info("Unit Test (calculate_current_inventory - Live Data) PASSED.")
        else:
            logger.error("Unit Test (calculate_current_inventory - Live Data) FAILED.")
            logger.error(f"Expected:\n{expected_current_inventory_df_live_test}")
            logger.error(f"Actual:\n{actual_current_inventory_df_test}")
    else:
        logger.warning("Skipping calculate_current_inventory live data test due to empty daily_inventory_df.")


    # Unit Test for calculate_12_month_rolling_average
    if not weekly_shipped_history_df.empty and key_skus_for_report:
        # Expected values updated based on actual output from earlier independent module tests
        expected_rolling_average_df_live_test = pd.DataFrame({
            'SKU': ['17612', '17904', '17914', '18675'],
            '12-Month Rolling Average': [471.25, 12.54, 28.04, 3.58] 
        })
        actual_rolling_average_df_test = calculate_12_month_rolling_average(weekly_shipped_history_df.copy(), key_skus_for_report)

        actual_rolling_average_df_test = actual_rolling_average_df_test.sort_values(by='SKU').reset_index(drop=True)
        expected_rolling_average_df_live_test = expected_rolling_average_df_live_test.sort_values(by='SKU').reset_index(drop=True)

        actual_rolling_average_df_test['12-Month Rolling Average'] = actual_rolling_average_df_test['12-Month Rolling Average'].astype(str)
        expected_rolling_average_df_live_test['12-Month Rolling Average'] = expected_rolling_average_df_live_test['12-Month Rolling Average'].astype(str)

        if actual_rolling_average_df_test.equals(expected_rolling_average_df_live_test):
            logger.info("Unit Test (calculate_12_month_rolling_average - Live Data) PASSED.")
        else:
            logger.error("Unit Test (calculate_12_month_rolling_average - Live Data) FAILED.")
            logger.error(f"Expected:\n{expected_rolling_average_df_live_test}")
            logger.error(f"Actual:\n{actual_rolling_average_df_test}")
    else:
        logger.warning("Skipping calculate_12_month_rolling_average live data test due to empty weekly_shipped_history_df or key_skus_for_report.")


    logger.info("Script finished. (All data loaded from Google Sheets and consolidated unit tests run)")
