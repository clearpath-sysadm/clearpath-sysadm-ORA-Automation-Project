import pandas as pd
import datetime
import math
import time
import logging

# Add the project root to the Python path to enable imports from services and config
import os
import sys
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
if project_root not in sys.path:
    sys.path.insert(0, project_root)

# Import the new Google Sheets API client service
from src.services.google_sheets.sheets_api import get_google_sheet_data, write_google_sheet_data
# Import inventory and average calculations from their new modules
from src.services.reporting_logic.inventory_calculations import calculate_current_inventory
from src.services.reporting_logic.average_calculations import calculate_12_month_rolling_average
# Import report data loader to get key SKUs (used in test block for simulating data)
from src.services.reporting_logic.report_data_loader import get_key_skus_and_product_names, get_weekly_shipped_history

# Import centralized configuration settings
from config import settings # Import the settings object

# Setup logging for this module.
# This ensures that if the script is run directly, logging is configured.
# If it's imported by a main script, that main script should handle setup_logging.
_log_dir = os.path.join(project_root, 'logs')
_log_file = os.path.join(_log_dir, 'app.log')
if not logging.getLogger().handlers:
    from utils.logging_config import setup_logging # Import here for direct execution
    setup_logging(log_file_path=_log_file, log_level=logging.INFO, enable_console_logging=True)
logger = logging.getLogger(__name__)


def generate_weekly_inventory_report(
    google_sheet_id: str, 
    weekly_report_tab_name: str, 
    service_account_file_path: str, 
    daily_inventory_df: pd.DataFrame, 
    weekly_shipped_history_df: pd.DataFrame, 
    key_skus_for_report: list, 
    product_names_map: dict
) -> pd.DataFrame:
    """
    Orchestrates the generation and writing of the Weekly Inventory Report.
    Combines current inventory and 12-month rolling average, then writes the result to Google Sheets.

    Args:
        google_sheet_id (str): ID of the Google Sheet.
        weekly_report_tab_name (str): Name of the weekly report tab in Google Sheet.
        service_account_file_path (str): Path to Google service account JSON key.
        daily_inventory_df (pd.DataFrame): DataFrame of daily inventory levels (BOD/EOD).
        weekly_shipped_history_df (pd.DataFrame): DataFrame of historical weekly shipped quantities.
        key_skus_for_report (list): List of SKU IDs for key products to include in the report.
        product_names_map (dict): Dictionary mapping SKU IDs to their product names.

    Returns:
        pd.DataFrame: The final DataFrame representing the Weekly Inventory Report.
                      Returns an empty DataFrame if required inputs are missing or processing fails.
    """
    logger.info("Generating Weekly Inventory Report...")

    if daily_inventory_df.empty or weekly_shipped_history_df.empty or not key_skus_for_report:
        logger.warning("Missing required input data (daily_inventory_df, weekly_shipped_history_df, or key_skus_for_report) for Weekly Inventory Report generation. Returning empty DataFrame.")
        return pd.DataFrame(columns=['SKU', 'Product', 'Quantity', 'Weekly Avg'])

    # Calculate Current Inventory using the imported function.
    current_inventory_df = calculate_current_inventory(daily_inventory_df, key_skus_for_report)
    logger.info(f"Calculated Current Inventory for Weekly Report. Shape: {current_inventory_df.shape}")
    logger.debug(f"Head:\n{current_inventory_df.head()}")

    # Calculate 12-Month Rolling Average using the imported function.
    rolling_average_df = calculate_12_month_rolling_average(weekly_shipped_history_df, key_skus_for_report)
    logger.info(f"Calculated 12-Month Rolling Average for Weekly Report. Shape: {rolling_average_df.shape}")
    logger.debug(f"Head:\n{rolling_average_df.head()}")

    # Merge current inventory and rolling average DataFrames based on SKU.
    weekly_report_df = pd.merge(
        current_inventory_df,
        rolling_average_df,
        on='SKU',
        how='outer' # Use outer merge to include all SKUs from both dataframes
    )
    
    # Add Product Name column using the provided product_names_map.
    weekly_report_df['Product'] = weekly_report_df['SKU'].map(product_names_map).fillna('N/A')

    # Clean and rename columns for the final report format.
    weekly_report_df['Quantity'] = weekly_report_df['Current Quantity'].fillna(0).astype(int) 
    weekly_report_df['Weekly Avg'] = weekly_report_df['12-Month Rolling Average'].apply( 
        # Handle "Insufficient Data" string from rolling average calculation
        lambda x: int(round(float(x))) if isinstance(x, (int, float)) else x
    ).fillna('N/A') # Fill any remaining NaNs after conversion with 'N/A'

    # Select and reorder final columns.
    final_columns = ['SKU', 'Product', 'Quantity', 'Weekly Avg'] 
    weekly_report_df = weekly_report_df[final_columns]
    
    logger.info(f"Final Weekly Inventory Report prepared. Shape: {weekly_report_df.shape}")
    logger.debug(f"Head:\n{weekly_report_df.head()}")

    logger.info("Attempting to write Weekly Inventory Report to Google Sheets...")
    write_google_sheet_data( # Using imported function
        google_sheet_id, 
        weekly_report_tab_name + "!A1", # Always write from A1 to clear the whole sheet
        service_account_file_path,
        weekly_report_df 
    )
    logger.info("Weekly Inventory Report writing process complete.")

    return weekly_report_df


# --- Main execution block for independent debugging of weekly_reporter.py ---
if __name__ == "__main__":
    logger.info("Starting Weekly Reporter (Independent Debugging) Script...")

    # --- Configuration directly from settings.py ---
    # All config values are now pulled directly from settings.
    # No need for a MockSettings class.
    # These variables are local copies for clarity in the test block, pulled from settings.
    GOOGLE_SHEET_ID_TEST = settings.GOOGLE_SHEET_ID
    SERVICE_ACCOUNT_KEY_PATH_TEST = settings.SERVICE_ACCOUNT_KEY_PATH
    WEEKLY_REPORT_TAB_NAME_TEST = settings.WEEKLY_REPORT_TAB_NAME
    ORA_CONFIGURATION_TAB_NAME_TEST = settings.ORA_CONFIGURATION_TAB_NAME
    ORA_WEEKLY_SHIPPED_HISTORY_TAB_NAME_TEST = settings.ORA_WEEKLY_SHIPPED_HISTORY_TAB_NAME

    # 1. Simulate key_skus_for_report and product_names_map (normally from report_data_loader.py)
    # This uses the actual data loading function, leveraging centralized config from settings.
    key_skus_for_test, product_names_test_map = get_key_skus_and_product_names(
        GOOGLE_SHEET_ID_TEST, 
        ORA_CONFIGURATION_TAB_NAME_TEST, 
        SERVICE_ACCOUNT_KEY_PATH_TEST
    )

    # 2. Simulate daily_inventory_df (normally from generate_monthly_charge_report)
    # The data itself remains hardcoded for consistent independent testing of this module's logic.
    simulated_daily_inventory_df_realistic = pd.DataFrame({
        'Date': pd.to_datetime(['2025-05-12', '2025-05-13', '2025-05-14', '2025-05-15', '2025-05-16',
                                '2025-05-12', '2025-05-13', '2025-05-14', '2025-05-15', '2025-05-16',
                                '2025-05-12', '2025-05-13', '2025-05-14', '2025-05-15', '2025-05-16',
                                '2025-05-12', '2025-05-13', '2025-05-14', '2025-05-15', '2025-05-16']),
        'SKU': ['17612']*5 + ['17904']*5 + ['17914']*5 + ['18675']*5,
        'ShippedQty': [87, 43, 97, 222, 67, # 17612
                       4, 2, 8, 15, 10,  # 17904
                       17, 8, 16, 30, 15, # 17914
                       0, 0, 0, 0, 0], # 18675
        'ReceivedQty': [0, 0, 0, 0, 528, # 17612
                        0, 0, 0, 0, 0,   # 17904
                        0, 0, 0, 0, 0,   # 17914
                        0, 0, 0, 0, 0],  # 18675
        'RepackedQty': [7, 0, 0, 0, 0,   # 17612
                        0, 0, 0, 0, 0,   # 17904
                        14, 0, 0, 0, 0,  # 17914
                        0, 0, 0, 0, 0],  # 18675
        'BOD_Qty': [615, 535, 492, 395, 173, # 17612
                    214, 210, 208, 200, 185, # 17904
                    416, 413, 405, 389, 359, # 17914
                    776, 776, 776, 776, 776], # 18675
        'EOD_Qty': [535, 492, 395, 173, 634, # 17612
                    210, 208, 200, 185, 175, # 17904
                    413, 405, 389, 359, 344, # 17914
                    776, 776, 776, 776, 776] # 18675
    })


    # 3. Simulate weekly_shipped_history_df (normally from get_weekly_shipped_history)
    # This uses the actual data loading function, leveraging centralized config from settings.
    simulated_weekly_shipped_history_df_all_skus = get_weekly_shipped_history(
        GOOGLE_SHEET_ID_TEST, 
        ORA_WEEKLY_SHIPPED_HISTORY_TAB_NAME_TEST, 
        SERVICE_ACCOUNT_KEY_PATH_TEST, 
        key_skus_for_test
    )


    # Run the report generation
    weekly_report_result_df = generate_weekly_inventory_report(
        google_sheet_id=GOOGLE_SHEET_ID_TEST, 
        weekly_report_tab_name=WEEKLY_REPORT_TAB_NAME_TEST, 
        service_account_file_path=SERVICE_ACCOUNT_KEY_PATH_TEST, 
        daily_inventory_df=simulated_daily_inventory_df_realistic, 
        weekly_shipped_history_df=simulated_weekly_shipped_history_df_all_skus, 
        key_skus_for_report=key_skus_for_test, 
        product_names_map=product_names_test_map 
    )
    
    logger.info("\n--- Independent Weekly Report Run Results ---")
    logger.info(f"Shape: {weekly_report_result_df.shape}")
    logger.info("Head:\n" + str(weekly_report_result_df.head()))
    logger.info("Independent test of Weekly Report Generator module finished.")
