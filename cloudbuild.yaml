# cloudbuild.yaml
options:
  logging: CLOUD_LOGGING_ONLY # This tells Cloud Build to send logs to Cloud Logging only

steps:
# DEBUGGING STEP: List contents of the project for verification
- name: 'gcr.io/cloud-builders/bash'
  args: ['ls', '-R', '.'] # This command will list all files and folders recursively from the root
  dir: . # Run this command from the root of your fetched repository

# Step to deploy shipstation-reporter-function
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
    - '-c'
    - |
      # Copy requirements.txt to src/ for deployment context
      cp requirements.txt src/
      # Rename the script to main.py for Cloud Functions standard entry point
      mv src/shipstation_reporter.py src/main.py
      
      gcloud functions deploy shipstation-reporter-function \
        --runtime python311 \
        --entry-point main \  # Changed to just 'main' now that the file is main.py
        --source=./src \
        --trigger-http \
        --allow-unauthenticated \
        --region=us-central1 \
        --memory=256MB \
        --timeout=300s \
        --set-env-vars GCP_PROJECT_ID=ora-automation-project
  dir: . # This ensures commands run from the project root

# You will add similar blocks for your other functions here when you're ready to deploy them.