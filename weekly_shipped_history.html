<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Weekly Reports - ORA Business Automation</title>
    
    <!-- Premium Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=Source+Serif+4:wght@600&display=swap" rel="stylesheet">
    
    <!-- Global Premium Design System -->
    <link rel="stylesheet" href="/static/css/global-styles.css">
    
</head>
<body>
<!-- Shipping Violations Alert Banner -->
<div class="violations-alert" id="violations-alert">
    <div class="violations-content">
        <span class="violations-icon">‚ö†Ô∏è</span>
        <div class="violations-text">
            <div class="violations-title">Shipping Configuration Alerts</div>
            <div class="violations-details" id="violations-summary">Loading...</div>
        </div>
    </div>
    <div class="violations-actions">
        <button class="btn-view-violations" onclick="openViolationsModal()">View Details</button>
        <button class="btn-dismiss-alert" onclick="dismissAlert()" title="Dismiss">√ó</button>
    </div>
</div>

<!-- Violations Modal -->
<div class="violations-modal" id="violations-modal" onclick="closeModalOnBackdrop(event)">
    <div class="violations-modal-content">
        <div class="violations-modal-header">
            <h2 class="violations-modal-title">Shipping Configuration Alerts</h2>
            <button class="btn-close-modal" onclick="closeViolationsModal()">√ó</button>
        </div>
        <div id="violations-list">
            <p style="text-align: center; color: var(--text-tertiary);">Loading violations...</p>
        </div>
    </div>
</div>


    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileMenu()"></div>

    <div class="app-container">
        <!-- Sidebar -->
                <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">O</div>
                <div class="sidebar-title">ORA Business</div>
            </div>
            
            <nav class="sidebar-nav">
                <!-- Primary Navigation -->
                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <a href="/" class="nav-item">
                        <span class="nav-item-icon">üìä</span>
                        Dashboard
                    </a>
                    <a href="/xml_import.html" class="nav-item">
                        <span class="nav-item-icon">üì•</span>
                        Orders Inbox
                    </a>
                    <a href="/inventory_transactions.html" class="nav-item">
                        <span class="nav-item-icon">üì¶</span>
                        Inventory Monitor
                    </a>
                    <a href="/lot_inventory.html" class="nav-item">
                        <span class="nav-item-icon">üè≠</span>
                        Lot Inventory
                    </a>
                    <a href="/charge_report.html" class="nav-item">
                        <span class="nav-item-icon">üí∞</span>
                        Charge Report
                    </a>
                </div>

                <!-- Admin Section -->
                <div class="nav-section admin-section">
                    <div class="admin-toggle" onclick="toggleAdmin()">
                        <span>Admin & Data</span>
                        <span class="admin-toggle-icon">‚ñ∂</span>
                    </div>
                    <div class="admin-items" id="admin-items">
                        <a href="/weekly_shipped_history.html" class="nav-item active">
                            <span class="nav-item-icon">üìà</span>
                            Weekly Reports
                        </a>
                        <a href="/shipped_orders.html" class="nav-item">
                            <span class="nav-item-icon">üìã</span>
                            Shipped Orders
                        </a>
                        <a href="/order_audit.html" class="nav-item">
                            <span class="nav-item-icon">üîç</span>
                            Order Audit
                        </a>
                        <a href="/shipped_items.html" class="nav-item">
                            <span class="nav-item-icon">üìä</span>
                            Shipped Items
                        </a>
                        <a href="/bundle_skus.html" class="nav-item">
                            <span class="nav-item-icon">üì¶</span>
                            Bundle SKUs
                        </a>
                        <a href="/sku_lot.html" class="nav-item">
                            <span class="nav-item-icon">üè∑Ô∏è</span>
                            SKU Lot Management
                        </a>
                        <a href="/workflow_controls.html" class="nav-item">
                            <span class="nav-item-icon">‚öôÔ∏è</span>
                            Workflow Controls
                        </a>
                    </div>
                </div>

                <!-- Settings Section -->
                <div class="nav-section" style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: calc(var(--spacing-unit) * 2);">
                    <a href="/help.html" class="nav-item">
                        <span class="nav-item-icon">üìö</span>
                        Help & Training
                    </a>
                    <a href="/settings.html" class="nav-item">
                        <span class="nav-item-icon">‚öôÔ∏è</span>
                        Settings
                    </a>
                </div>
            </nav>
        </aside>


        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                    <div>
                        <h1 class="page-title">Weekly Reports</h1>
                    </div>
                </div>
                <div class="top-bar-actions">
                    <button class="dark-mode-toggle" onclick="toggleDarkMode()">üåô</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Filter Controls -->
                <div class="controls">
                    <label for="skuFilter">
                        <strong>Filter by SKU:</strong>
                    </label>
                    <select id="skuFilter">
                        <option value="">All SKUs</option>
                        <option value="17612">17612</option>
                        <option value="17904">17904</option>
                        <option value="17914">17914</option>
                        <option value="17975">17975</option>
                        <option value="18675">18675</option>
                        <option value="18795">18795</option>
                    </select>
                    <button class="btn" onclick="applyFilter()">Apply Filter</button>
                    <button class="btn" onclick="clearFilter()">Clear Filter</button>
                </div>

                <!-- Summary Cards -->
                <div id="summarySection" class="summary-cards" style="display: none;">
                    <div class="summary-card">
                        <h3>Total Weeks</h3>
                        <div class="value" id="totalWeeks">0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Total Shipped</h3>
                        <div class="value" id="totalShipped">0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Weekly Average</h3>
                        <div class="value" id="weeklyAvg">0</div>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="errorMessage" class="error" style="display: none;"></div>

                <!-- Data Table -->
                <div class="card">
                    <div class="table-header">
                        <div class="table-title">52-Week Shipping History</div>
                        <div class="record-count" id="recordCount">Loading...</div>
                    </div>

                    <div id="loadingMessage" class="loading">
                        Loading weekly shipped history...
                    </div>

                    <table id="historyTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Week Start</th>
                                <th>Week End</th>
                                <th>SKU</th>
                                <th class="text-right">Quantity Shipped</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="/static/dark-mode.js"></script>
    <script src="/static/js/auth.js"></script>


    <script>
        // Layout JavaScript Functions
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        }

        function closeMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        }

        function toggleAdmin() {
            const toggle = document.querySelector('.admin-toggle');
            const items = document.getElementById('admin-items');
            toggle.classList.toggle('expanded');
            items.classList.toggle('expanded');
        }        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeMobileMenu();
            }
        });

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 1024) {
                    closeMobileMenu();
                }
            });
        });

        // Page-specific JavaScript
        let currentFilter = '';

        async function loadHistory(skuFilter = '') {
            try {
                document.getElementById('loadingMessage').style.display = 'block';
                document.getElementById('historyTable').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('summarySection').style.display = 'none';

                const url = skuFilter 
                    ? `/api/weekly_shipped_history?sku=${encodeURIComponent(skuFilter)}`
                    : '/api/weekly_shipped_history';

                const response = await fetch(url);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to load data');
                }

                displayHistory(result.data, result.count);
                calculateSummary(result.data, skuFilter);
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('errorMessage').textContent = 
                    'Error loading data: ' + error.message;
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('loadingMessage').style.display = 'none';
            }
        }

        function displayHistory(data, count) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: var(--text-tertiary);">No data available</td></tr>';
                document.getElementById('recordCount').textContent = '0 records';
            } else {
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${row.start_date}</td>
                        <td>${row.end_date}</td>
                        <td><span class="sku-badge">${row.sku}</span></td>
                        <td class="text-right">${row.quantity_shipped}</td>
                    `;
                    tbody.appendChild(tr);
                });

                document.getElementById('recordCount').textContent = `${count} records`;
            }

            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('historyTable').style.display = 'table';
        }

        function calculateSummary(data, skuFilter) {
            if (skuFilter && data.length > 0) {
                const totalWeeks = data.length;
                const totalShipped = data.reduce((sum, row) => sum + row.quantity_shipped, 0);
                const weeklyAvg = Math.round(totalShipped / totalWeeks);

                document.getElementById('totalWeeks').textContent = totalWeeks;
                document.getElementById('totalShipped').textContent = totalShipped.toLocaleString();
                document.getElementById('weeklyAvg').textContent = weeklyAvg;
                document.getElementById('summarySection').style.display = 'grid';
            } else {
                document.getElementById('summarySection').style.display = 'none';
            }
        }

        function applyFilter() {
            const sku = document.getElementById('skuFilter').value;
            currentFilter = sku;
            loadHistory(sku);
        }

        function clearFilter() {
            document.getElementById('skuFilter').value = '';
            currentFilter = '';
            loadHistory();
        }

        // Fetch and display last updated timestamp
        async function fetchLastUpdated() {
            try {
                const response = await fetch('/api/weekly_inventory_report');
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    const lastUpdated = result.data[0].last_updated;
                    if (lastUpdated) {
                        const date = new Date(lastUpdated);
                        const options = { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric', 
                            hour: '2-digit', 
                            minute: '2-digit'
                        };
                        document.getElementById('lastUpdatedTime').textContent = 
                            date.toLocaleString('en-US', options);
                    }
                }
            } catch (error) {
                console.error('Error fetching last updated:', error);
                document.getElementById('lastUpdatedTime').textContent = 'Unknown';
            }
        }

        // EOD Button Handler
        async function runEOD() {
            const btn = document.getElementById('btn-eod');
            const statusDiv = document.getElementById('eod-status');
            const originalStatus = statusDiv.textContent;
            
            btn.disabled = true;
            statusDiv.textContent = 'Running...';
            btn.style.opacity = '0.6';
            
            try {
                const response = await fetch('/api/reports/eod', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    // Refresh weekly report data
                    await fetchLastUpdated();
                    await loadHistory(currentFilter);
                    
                    alert('‚úÖ ' + result.message);
                    await loadReportStatus(); // Update button status
                } else {
                    throw new Error(result.error || 'Failed to run EOD');
                }
            } catch (error) {
                console.error('Error running EOD:', error);
                alert('Error running EOD: ' + error.message);
                statusDiv.textContent = originalStatus;
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        // EOW Button Handler
        async function runEOW() {
            const btn = document.getElementById('btn-eow');
            const statusDiv = document.getElementById('eow-status');
            const originalStatus = statusDiv.textContent;
            
            btn.disabled = true;
            statusDiv.textContent = 'Running...';
            btn.style.opacity = '0.6';
            
            try {
                const response = await fetch('/api/reports/eow', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    // Refresh weekly report data
                    await fetchLastUpdated();
                    await loadHistory(currentFilter);
                    
                    alert('‚úÖ ' + result.message);
                    await loadReportStatus(); // Update button status
                } else {
                    throw new Error(result.error || 'Failed to run EOW');
                }
            } catch (error) {
                console.error('Error running EOW:', error);
                alert('Error running EOW: ' + error.message);
                statusDiv.textContent = originalStatus;
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        // EOM Button Handler
        async function runEOM() {
            const btn = document.getElementById('btn-eom');
            const statusDiv = document.getElementById('eom-status');
            const originalStatus = statusDiv.textContent;
            
            btn.disabled = true;
            statusDiv.textContent = 'Running...';
            btn.style.opacity = '0.6';
            
            try {
                const response = await fetch('/api/reports/eom', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ ' + result.message);
                    await loadReportStatus(); // Update button status
                } else {
                    throw new Error(result.error || 'Failed to run EOM');
                }
            } catch (error) {
                console.error('Error running EOM:', error);
                alert('Error running EOM: ' + error.message);
                statusDiv.textContent = originalStatus;
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        // Load report status and update button timestamps
        async function loadReportStatus() {
            try {
                const response = await fetch('/api/reports/status');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const formatTime = (dateStr) => {
                        if (!dateStr) return 'Never run';
                        const date = new Date(dateStr);
                        return date.toLocaleString('en-US', { 
                            month: 'short', 
                            day: 'numeric', 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    };
                    
                    if (result.data.EOD) {
                        document.getElementById('eod-status').textContent = formatTime(result.data.EOD.run_date);
                    }
                    if (result.data.EOW) {
                        document.getElementById('eow-status').textContent = formatTime(result.data.EOW.run_date);
                    }
                    if (result.data.EOM) {
                        document.getElementById('eom-status').textContent = formatTime(result.data.EOM.run_date);
                    }
                }
            } catch (error) {
                console.error('Error loading report status:', error);
            }
        }

        // Load initial data
        loadHistory();
        fetchLastUpdated();
        loadReportStatus();
    </script>
    <script src="/static/js/auth.js"></script>
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Report button status styling */
        .btn-status {
            font-size: 10px;
            color: var(--text-tertiary);
            margin-top: 2px;
            font-weight: 400;
        }
    </style>
    <script src="/static/shipping-violations-alert.js"></script>
    <script src="/static/js/auth.js"></script>
    <!-- Interactive Training Tours -->
    <script src="/static/tour.js"></script>
    <script src="/static/js/auth.js"></script>
</body>
</html>
