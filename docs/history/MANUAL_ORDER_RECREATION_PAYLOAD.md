# Manual Order Recreation Payload Verification

## Process Overview
When recreating a conflicting manual order, the system:
1. Fetches the complete order from ShipStation API
2. Finds the next available order number (max < 200000, then +1)
3. Creates a **complete copy** of the order with the new order number
4. Removes only the IDs that must be regenerated by ShipStation
5. Sends the payload to ShipStation's `/orders/createorder` endpoint

---

## Payload Structure

### ✅ DATA THAT IS COPIED (Preserved)

The system preserves **ALL** order data from the original, including:

#### Customer Information
- `orderNumber` ← **UPDATED to new incremented value**
- `orderDate`
- `paymentDate`
- `shipByDate`
- `orderStatus` (e.g., "awaiting_shipment")
- `customerUsername`
- `customerEmail`
- `customerNotes`
- `internalNotes` ← **PRESERVED**
- `gift` (boolean)
- `giftMessage` ← **PRESERVED**

#### Shipping Address (`shipTo`)
- `name`
- `company` ← **PRESERVED**
- `street1`, `street2`, `street3`
- `city`
- `state`
- `postalCode`
- `country`
- `phone`
- `residential` (boolean)

#### Billing Address (`billTo`)
- Same structure as shipTo
- Fully preserved

#### Items (`items[]`)
Each item includes:
- `sku` ← **PRESERVED with lot number**
- `name` (product name)
- `quantity`
- `unitPrice`
- `taxAmount`
- `shippingAmount`
- `warehouseLocation`
- `options` (item options/customizations)
- `productId`
- `fulfillmentSku`
- `adjustment` (boolean)
- `upc`
- `createDate`
- `modifyDate`
- `weight` (weight object with value, units, WeightUnits)

#### Shipping & Service
- `amountPaid`
- `taxAmount`
- `shippingAmount`
- `carrierCode` ← **PRESERVED**
- `serviceCode` ← **PRESERVED**
- `packageCode`
- `confirmation` (delivery confirmation type)
- `shipDate`
- `holdUntilDate`
- `weight` (package weight object)
- `dimensions` (length, width, height, units)
- `insuranceOptions` (provider, insureShipment, insuredValue)
- `internationalOptions` (customs declarations if applicable)
- `advancedOptions` (all shipping preferences)

#### Tags & Custom Fields
- `tagIds` ← **PRESERVED** (all order tags)
- `customField1`, `customField2`, `customField3` ← **PRESERVED**

#### Other Metadata
- `requestedShippingService`
- `storeId`
- `advancedOptions` (full object):
  - `warehouseId`
  - `nonMachinable`
  - `saturdayDelivery`
  - `containsAlcohol`
  - `mergedOrSplit`
  - `mergedIds`
  - `parentId`
  - `billToParty`
  - `billToAccount`
  - `billToPostalCode`
  - `billToCountryCode`
  - `customField1`, `customField2`, `customField3`

---

### ❌ DATA THAT IS REMOVED (Must be regenerated by ShipStation)

These IDs are removed because ShipStation assigns new values:

```python
new_order.pop('orderId', None)           # Main order ID - ShipStation generates new
new_order.pop('orderKey', None)          # Order key - ShipStation generates new
for item in new_order.get('items', []):
    item.pop('orderItemId', None)        # Item IDs - ShipStation generates new per item
```

**Why remove these?**
- ShipStation requires these to be absent or null for new order creation
- Sending existing IDs would cause conflicts or updates instead of creation
- ShipStation automatically generates new unique IDs for the new order

---

## Fixed Issues (October 20, 2025)

### Bug Fixes Applied:
1. **Response object parsing** - Fixed `.json()` calls on all API responses
2. **Parameter naming** - Changed `json=new_order` to `data=new_order` for POST requests
3. **Status code checks** - Added explicit `status_code != 200` validation

### Before (Broken):
```python
order_response = make_api_request(...)
new_order = order_response.copy()  # ❌ Response object has no .copy()
```

### After (Fixed):
```python
order_resp = make_api_request(...)
order_response = order_resp.json()  # ✅ Parse JSON first
new_order = order_response.copy()   # ✅ Now works on dict
```

---

## Complete Data Preservation Guarantee

**The system creates a 1:1 copy** of the manual order with these exceptions:
- New `orderNumber` (incremented)
- New `orderId` (generated by ShipStation)
- New `orderKey` (generated by ShipStation)
- New `orderItemId` values (generated by ShipStation)

**Everything else is identical:**
- All customer information
- All addresses
- All items with SKU-Lot mappings
- All tags and custom fields
- All shipping preferences
- All notes (internal and customer)
- Gift messages
- Insurance, customs, and advanced options

---

## API Endpoint
```
POST https://ssapi.shipstation.com/orders/createorder
```

## Headers
```python
{
    'Authorization': 'Basic <base64(api_key:api_secret)>',
    'Content-Type': 'application/json'
}
```

## Response
ShipStation returns the newly created order with:
- New `orderId` (stored as `new_shipstation_order_id`)
- New `orderNumber` (stored as `new_order_number`)
- All other fields as submitted

---

## Verification Checklist

Before clicking "Confirm Delete Old Order":
1. ✅ New order number is correct (incremented)
2. ✅ Customer name matches
3. ✅ Company name matches
4. ✅ All items present with correct SKU-Lot
5. ✅ Quantities match exactly
6. ✅ Shipping address is identical
7. ✅ Tags are preserved
8. ✅ Internal/customer notes present
9. ✅ Order status is correct
10. ✅ Carrier/service preferences preserved
